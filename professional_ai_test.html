<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI人格特質測驗 - 發現你的AI人格類型</title>
    <meta name="description" content="全球首創AI人格特質測驗，發現你是哪種AI人格類型！">
    <meta property="og:title" content="AI人格特質測驗 - 你是AI先鋒者還是AI學者？">
    <meta property="og:description" content="3分鐘發現你的AI人格特質，了解全球分佈！">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/667eea/ffffff?text=AI%E4%BA%BA%E6%A0%BC%E7%89%B9%E8%B3%AA%E6%B8%AC%E9%A9%97">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .hero-section {
            text-align: center;
            padding: 60px 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 200% 100%;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .hero-title {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .personality-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
        }

        .personality-type {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .personality-type:hover {
            transform: translateY(-3px);
        }

        .personality-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .personality-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .creator-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .creator-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .test-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            position: relative;
            overflow: hidden;
        }

        .user-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-container {
            margin-bottom: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .question-container {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.4s ease;
        }

        .question-container.changing {
            opacity: 0;
            transform: translateX(30px);
        }

        .question-number {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.3;
        }

        .options-grid {
            display: grid;
            gap: 15px;
            margin: 30px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e8ecf4;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.02);
        }

        /* 新增：選擇後的loading狀態 */
        .option-card.loading {
            position: relative;
            pointer-events: none;
        }

        .option-card.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 20px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translateY(-50%);
        }

        .option-label {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .option-description {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* 下一題loading提示 */
        .next-question-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .next-question-loading.show {
            opacity: 1;
        }

        .next-question-loading .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .result-container.show {
            display: block;
            animation: resultAppear 0.8s ease forwards;
        }

        @keyframes resultAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .personality-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 120px;
            font-size: 48px;
            margin-bottom: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }

        .result-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-subtitle {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .result-description {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .personality-traits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .trait-card {
            background: rgba(102, 126, 234, 0.1);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .trait-name {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .trait-stars {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .star {
            color: #ffd700;
            font-size: 20px;
            margin: 0 2px;
        }

        .star.empty {
            color: #ddd;
        }

        /* 修改：全球統計（不是排名） */
        .global-stats {
            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            border: 2px solid #2196f3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-big-number {
            font-size: 32px;
            font-weight: 800;
            color: #2196f3;
            margin-bottom: 5px;
        }

        .stat-description {
            font-size: 14px;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 15px 40px rgba(240, 147, 251, 0.4);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 修改：人格分佈統計（取代排行榜） */
        .personality-stats-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            display: none;
        }

        .personality-distribution {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .personality-stat-item {
            display: flex;
            align-items: center;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .personality-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .personality-stat-icon {
            font-size: 48px;
            margin-right: 25px;
            width: 80px;
            text-align: center;
        }

        .personality-stat-info {
            flex-grow: 1;
        }

        .personality-stat-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .personality-stat-subtitle {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .personality-stat-bar {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-right: 20px;
        }

        .personality-stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .personality-stat-percent {
            font-size: 24px;
            font-weight: 800;
            color: #667eea;
            min-width: 60px;
            text-align: center;
        }

        .error-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .error-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .error-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .error-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .connection-status.offline {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .connection-status.demo {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 36px;
            }
            
            .test-container, .result-container {
                padding: 30px 20px;
                margin: 20px 0;
                border-radius: 20px;
            }
            
            .question-title {
                font-size: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .personality-traits {
                grid-template-columns: 1fr;
            }

            .error-content {
                margin: 20px;
                padding: 30px 20px;
            }

            .error-buttons {
                flex-direction: column;
            }

            .personality-stat-item {
                flex-direction: column;
                text-align: center;
            }

            .personality-stat-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .personality-stat-bar {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <!-- 連接狀態指示器 -->
    <div class="connection-status" id="connectionStatus">連接中...</div>

    <div class="container">
        <!-- 標題區域 -->
        <div class="hero-section">
            <h1 class="hero-title">🧠 AI人格特質測驗</h1>
            <p class="hero-subtitle">發現你獨特的AI人格類型</p>
            <p style="color: #888; margin-bottom: 20px;">
                3分鐘了解你的AI使用人格，找到專屬的AI夥伴類型！
            </p>
            
            <div class="personality-preview">
                <div class="personality-type">
                    <div class="personality-icon">🚀</div>
                    <div class="personality-name">AI先鋒者</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">🎨</div>
                    <div class="personality-name">AI創意家</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">⚡</div>
                    <div class="personality-name">AI效率王</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">🔬</div>
                    <div class="personality-name">AI學者</div>
                </div>
            </div>
            
            <a href="https://portaly.cc/zn.studio" target="_blank" class="creator-badge">
                <span style="margin-right: 8px;">💡</span>
                由 Nick Chang | ZN Studio 創作
            </a>
        </div>

        <!-- 即時統計 -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">載入中...</div>
                <div class="stat-label">全球參與人數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mostCommon">載入中...</div>
                <div class="stat-label">最常見人格</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rarest">載入中...</div>
                <div class="stat-label">最稀有人格</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineNow">載入中...</div>
                <div class="stat-label">目前在線</div>
            </div>
        </div>

        <!-- 測驗區域 -->
        <div class="test-container" id="testContainer">
            <!-- 用戶資料表單 -->
            <div class="user-form">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                    📝 請填寫基本資料以參與全球統計
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">暱稱 *</label>
                        <input type="text" id="username" placeholder="請輸入你的暱稱" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="location">地區</label>
                        <select id="location">
                            <option value="">選擇地區（可選）</option>
                            <option value="台北">台北</option>
                            <option value="新北">新北</option>
                            <option value="桃園">桃園</option>
                            <option value="台中">台中</option>
                            <option value="台南">台南</option>
                            <option value="高雄">高雄</option>
                            <option value="其他台灣地區">其他台灣地區</option>
                            <option value="香港">香港</option>
                            <option value="新加坡">新加坡</option>
                            <option value="馬來西亞">馬來西亞</option>
                            <option value="中國大陸">中國大陸</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="occupation">職業</label>
                        <select id="occupation">
                            <option value="">選擇職業（可選）</option>
                            <option value="學生">學生</option>
                            <option value="工程師">工程師</option>
                            <option value="設計師">設計師</option>
                            <option value="行銷人員">行銷人員</option>
                            <option value="創業者">創業者</option>
                            <option value="教師">教師</option>
                            <option value="醫護人員">醫護人員</option>
                            <option value="金融業">金融業</option>
                            <option value="服務業">服務業</option>
                            <option value="自由工作者">自由工作者</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ageGroup">年齡層</label>
                        <select id="ageGroup">
                            <option value="">選擇年齡層（可選）</option>
                            <option value="18-24">18-24歲</option>
                            <option value="25-34">25-34歲</option>
                            <option value="35-44">35-44歲</option>
                            <option value="45-54">45-54歲</option>
                            <option value="55+">55歲以上</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">準備開始測驗</div>
            </div>

            <div class="question-container" id="questionContainer">
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">🧠 探索你的AI人格特質</h2>
                    <p style="color: #666; margin-bottom: 30px;">
                        通過8個問題，了解你與AI互動的獨特風格和偏好
                    </p>
                    <button class="btn" onclick="startTest()" style="font-size: 18px; padding: 20px 50px;">
                        🚀 開始探索
                    </button>
                </div>
            </div>

            <!-- 新增：下一題loading提示 -->
            <div class="next-question-loading" id="nextQuestionLoading">
                <div class="spinner-small"></div>
                準備下一題...
            </div>
        </div>

        <!-- 結果區域 -->
        <div class="result-container" id="resultContainer">
            <div class="personality-badge" id="personalityBadge">🚀</div>
            <h2 class="result-title" id="resultTitle">AI先鋒者</h2>
            <p class="result-subtitle" id="resultSubtitle">"AI的未來，我來創造！"</p>
            <p class="result-description" id="resultDescription">結果描述</p>

            <div class="personality-traits">
                <div class="trait-card">
                    <div class="trait-name">創新探索</div>
                    <div class="trait-stars" id="innovation-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">效率提升</div>
                    <div class="trait-stars" id="efficiency-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">創意表達</div>
                    <div class="trait-stars" id="creativity-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">深度理解</div>
                    <div class="trait-stars" id="understanding-stars"></div>
                </div>
            </div>

            <!-- 修改：全球統計資訊（不是排名） -->
            <div class="global-stats">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">🌍 你的人格特質統計</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-big-number" id="sameTypeCount">1,247</div>
                        <div class="stat-description">同類型人數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-big-number" id="personalityPercent">23%</div>
                        <div class="stat-description">全球佔比</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-big-number" id="personalityRarity">常見</div>
                        <div class="stat-description">稀有程度</div>
                    </div>
                </div>
                <p style="color: #666; font-size: 14px; margin-top: 15px;">
                    每種AI人格都有其獨特價值！沒有優劣之分，只有不同的特色和優勢 ✨
                </p>
            </div>

            <div style="margin: 40px 0;">
                <button class="btn" onclick="shareResult()">
                    📤 分享我的AI人格
                </button>
                <button class="btn btn-secondary" onclick="showPersonalityStats()">
                    📊 查看人格分佈統計
                </button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    <strong>想了解更多AI人格特質？</strong><br>
                    Nick Chang｜nickleo051216@gmail.com｜0932-684-051<br>
                    個人網站：ZN Studio｜<a href="https://portaly.cc/zn.studio" target="_blank" style="color: #667eea;">https://portaly.cc/zn.studio</a><br>
                    Threads： ZN Studio ( @nickai216 )  <a href="https://www.threads.com/@nickai216" target="_blank" style="color: #667eea;">https://www.threads.com/@nickai216</a><br>
                    Line 社群：<a href="https://reurl.cc/1OZNAY" target="_blank" style="color: #667eea;">https://reurl.cc/1OZNAY</a><br>
                    Line ： <a href="https://lin.ee/Faz0doj" target="_blank" style="color: #667eea;">https://lin.ee/Faz0doj</a>
                </p>
                <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                    加入Nick Chang的Line社群，與同類型夥伴交流！
                </p>
                <a href="https://reurl.cc/1OZNAY" target="_blank" class="btn" style="font-size: 14px; padding: 12px 24px;">
                    🎯 加入AI人格社群
                </a>
            </div>
        </div>

        <!-- 修改：人格分佈統計區域（取代排行榜） -->
        <div class="personality-stats-section" id="personalityStatsSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">📊 全球AI人格分佈統計</h2>
            <div id="personalityStatsContent">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>載入統計數據中...</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="hidePersonalityStats()">返回結果</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // 全域變數和設定
        // ===============================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAqwdMVnhrj0Ktj9BTEOVJdpzBLPpMaTq",
            authDomain: "ai-level-test.firebaseapp.com", 
            projectId: "ai-level-test",
            storageBucket: "ai-level-test.firebasestorage.app",
            messagingSenderId: "774029966921",
            appId: "1:774029966921:web:5bceaeb011e665f4ccc40c",
            measurementId: "G-TH0M0VXRZC"
        };

        let db = null;
        let firebaseInitialized = false;
        let connectionMode = 'connecting'; // connecting, online, offline, demo
        let currentQuestion = 0;
        let answers = {};
        let startTime = Date.now();
        let userResult = null;
        let pendingStatsRequest = false;

        // AI人格類型定義
        const personalityTypes = {
            pioneer: {
                icon: '🚀',
                name: 'AI先鋒者',
                subtitle: '"AI的未來，我來創造！"',
                animal: '雄鷹 🦅',
                description: '你總是第一個接觸新AI技術的人！具有強烈的探索精神和創新思維，喜歡嘗試各種前沿AI工具，並能敏銳地洞察AI發展趨勢。你不僅是AI的使用者，更是AI時代的引領者，用你的熱情和遠見影響著周圍的人。',
                traits: {
                    innovation: 5,
                    efficiency: 4,
                    creativity: 4,
                    understanding: 3
                }
            },
            creator: {
                icon: '🎨',
                name: 'AI創意家',
                subtitle: '"AI是我的創意夥伴！"',
                animal: '蝴蝶 🦋',
                description: '你擁有豐富的想像力和創造力！善於運用AI進行藝術創作、內容生成和創意表達。你將AI視為創意的延伸，能夠與AI協作產出令人驚艷的作品。你的創作總是充滿個性和感染力，激發他人的創意靈感。',
                traits: {
                    innovation: 4,
                    efficiency: 3,
                    creativity: 5,
                    understanding: 3
                }
            },
            efficiency: {
                icon: '⚡',
                name: 'AI效率王',
                subtitle: '"效率就是生產力！"',
                animal: '獵豹 🐆',
                description: '你是追求效率和結果的實踐者！專注於運用AI工具提升工作和學習效率，能夠快速找到最適合的AI解決方案。你的時間管理能力極強，總是能用最短的時間達成最佳效果。你是職場上的AI效率專家。',
                traits: {
                    innovation: 3,
                    efficiency: 5,
                    creativity: 3,
                    understanding: 4
                }
            },
            scholar: {
                icon: '🔬',
                name: 'AI學者',
                subtitle: '"知識就是力量！"',
                animal: '貓頭鷹 🦉',
                description: '你是AI領域的深度思考者！喜歡探究AI的工作原理和技術細節，具有強烈的求知慾和學習能力。你重視知識的準確性和深度，能夠理性分析AI的優劣勢。你的見解總是深刻而有價值，是他人學習AI的可靠導師。',
                traits: {
                    innovation: 3,
                    efficiency: 4,
                    creativity: 3,
                    understanding: 5
                }
            }
        };

        // 重新設計的問題庫（AI人格導向）
        const questions = [
            {
                title: "你最初開始使用AI是因為？",
                options: [
                    { label: "🚀 聽說很酷，想嘗試新科技", desc: "對新事物充滿好奇，喜歡探索前沿技術", type: 'pioneer' },
                    { label: "🎨 想要實現創意想法", desc: "希望用AI來輔助創作和表達", type: 'creator' },
                    { label: "⚡ 工作需要，提升效率", desc: "為了解決實際問題，提高工作效率", type: 'efficiency' },
                    { label: "🔬 想深入了解AI原理", desc: "對AI技術本身感興趣，想學習知識", type: 'scholar' }
                ]
            },
            {
                title: "面對新的AI工具，你通常會？",
                options: [
                    { label: "🎯 馬上下載試用", desc: "立即嘗試，邊用邊學", type: 'pioneer' },
                    { label: "🎨 想像創作可能性", desc: "思考能用它創造什麼有趣的作品", type: 'creator' },
                    { label: "📊 評估實用價值", desc: "分析它能為工作帶來什麼幫助", type: 'efficiency' },
                    { label: "📚 先研究技術文檔", desc: "了解原理和功能後再使用", type: 'scholar' }
                ]
            },
            {
                title: "你最喜歡用AI做什麼？",
                options: [
                    { label: "🔬 探索各種可能性", desc: "嘗試AI的各種功能和應用場景", type: 'pioneer' },
                    { label: "🎭 創作和表達想法", desc: "用AI進行藝術創作、內容生成", type: 'creator' },
                    { label: "📈 解決工作問題", desc: "用AI處理日常任務，提升效率", type: 'efficiency' },
                    { label: "📖 學習和研究", desc: "用AI輔助學習，深入理解知識", type: 'scholar' }
                ]
            },
            {
                title: "當你發現AI的新功能時，你會？",
                options: [
                    { label: "📢 立即分享給朋友", desc: "興奮地告訴大家這個發現", type: 'pioneer' },
                    { label: "💡 思考創作靈感", desc: "考慮如何用於自己的創作", type: 'creator' },
                    { label: "🎯 評估工作應用", desc: "分析如何應用到實際工作中", type: 'efficiency' },
                    { label: "🔍 深入研究細節", desc: "詳細了解功能原理和限制", type: 'scholar' }
                ]
            },
            {
                title: "你覺得AI最吸引你的地方是？",
                options: [
                    { label: "🌟 無限的可能性", desc: "AI技術的發展前景和未來潛力", type: 'pioneer' },
                    { label: "🎨 創意的延伸", desc: "能幫助實現以前無法做到的創意", type: 'creator' },
                    { label: "⚡ 效率的提升", desc: "大幅提高工作和生活效率", type: 'efficiency' },
                    { label: "🧠 智能的奧秘", desc: "AI背後的技術原理和運作方式", type: 'scholar' }
                ]
            },
            {
                title: "在AI學習路上，你最重視？",
                options: [
                    { label: "🚀 緊跟最新趨勢", desc: "總是關注最新的AI發展動態", type: 'pioneer' },
                    { label: "🎪 激發創意靈感", desc: "學習如何用AI激發更多創意", type: 'creator' },
                    { label: "📊 掌握實用技能", desc: "學習能直接應用的實用技巧", type: 'efficiency' },
                    { label: "📚 建立知識體系", desc: "系統化地學習AI相關知識", type: 'scholar' }
                ]
            },
            {
                title: "你希望AI在你生活中扮演什麼角色？",
                options: [
                    { label: "🧭 探險夥伴", desc: "一起探索未知的技術前沿", type: 'pioneer' },
                    { label: "🎨 創作搭檔", desc: "協助實現各種創意想法", type: 'creator' },
                    { label: "⚙️ 效率工具", desc: "幫助處理各種日常任務", type: 'efficiency' },
                    { label: "📖 智慧導師", desc: "提供知識和深入的見解", type: 'scholar' }
                ]
            },
            {
                title: "對於AI的未來發展，你最期待？",
                options: [
                    { label: "🌍 改變世界的突破", desc: "期待AI帶來革命性的變化", type: 'pioneer' },
                    { label: "🎭 更豐富的創作可能", desc: "希望AI能支援更多創意表達", type: 'creator' },
                    { label: "🔧 更實用的功能", desc: "期待更高效便利的AI工具", type: 'efficiency' },
                    { label: "🧠 更深層的智能", desc: "希望AI能達到更高的智能水準", type: 'scholar' }
                ]
            }
        ];

        // ===============================
        // Firebase 和連接管理
        // ===============================

        async function initializeFirebase() {
            updateConnectionStatus('connecting');
            
            try {
                // 檢查Firebase配置是否完整
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "API須更新") {
                    throw new Error('Firebase配置未完成');
                }

                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // 測試連接
                await testFirebaseConnection();
                
                firebaseInitialized = true;
                updateConnectionStatus('online');
                console.log('Firebase 初始化成功');
                setupRealTimeStats();
                
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                firebaseInitialized = false;
                
                // 顯示錯誤對話框，讓用戶選擇
                showConnectionErrorDialog(error.message);
            }
        }

        async function testFirebaseConnection() {
            // 嘗試讀取一個簡單的文檔來測試連接
            const testRef = db.collection('test').doc('connection');
            await testRef.get();
        }

        function updateConnectionStatus(status) {
            connectionMode = status;
            const statusElement = document.getElementById('connectionStatus');
            
            switch (status) {
                case 'connecting':
                    statusElement.textContent = '🔄 連接中...';
                    statusElement.className = 'connection-status connecting';
                    break;
                case 'online':
                    statusElement.textContent = '🟢 線上模式';
                    statusElement.className = 'connection-status online';
                    break;
                case 'offline':
                    statusElement.textContent = '🔴 離線模式';
                    statusElement.className = 'connection-status offline';
                    break;
                case 'demo':
                    statusElement.textContent = '🟡 演示模式';
                    statusElement.className = 'connection-status demo';
                    break;
            }
        }

        function showConnectionErrorDialog(errorMessage) {
            const dialog = document.createElement('div');
            dialog.className = 'error-dialog';
            dialog.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">⚠️</div>
                    <div class="error-title">連接失敗</div>
                    <div class="error-message">
                        無法連接到資料庫服務器。<br>
                        <small style="color: #999;">錯誤詳情: ${errorMessage}</small><br><br>
                        是否要使用演示模式繼續？<br>
                        <small style="color: #666;">演示模式將顯示模擬數據，不會保存您的測驗結果。</small>
                    </div>
                    <div class="error-buttons">
                        <button class="btn-confirm" onclick="useDemoMode()">是，使用演示模式</button>
                        <button class="btn-cancel" onclick="useOfflineMode()">否，顯示離線狀態</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function useDemoMode() {
            document.querySelector('.error-dialog')?.remove();
            updateConnectionStatus('demo');
            simulateStats();
        }

        function useOfflineMode() {
            document.querySelector('.error-dialog')?.remove();
            updateConnectionStatus('offline');
            showOfflineStats();
        }

        function showOfflineStats() {
            updateStatsUI({
                total_users: 0,
                most_common: '無數據',
                rarest: '無數據',
                online_now: 0
            });
        }

        // ===============================
        // 統計數據管理
        // ===============================

        function simulateStats() {
            const mockStats = {
                total_users: 15847,
                most_common: 'AI效率王',
                rarest: 'AI學者',
                online_now: 2341
            };
            updateStatsUI(mockStats);
            
            // 模擬即時更新
            setInterval(() => {
                mockStats.total_users += Math.floor(Math.random() * 3);
                mockStats.online_now = Math.floor(mockStats.total_users * (0.1 + Math.random() * 0.2));
                updateStatsUI(mockStats);
            }, 10000);
        }

        function updateStatsUI(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users?.toLocaleString() || '0';
            document.getElementById('mostCommon').textContent = stats.most_common || '無數據';
            document.getElementById('rarest').textContent = stats.rarest || '無數據';
            document.getElementById('onlineNow').textContent = stats.online_now?.toLocaleString() || '0';
        }

        async function setupRealTimeStats() {
            if (!firebaseInitialized) return;
            
            try {
                db.collection('personality_stats').doc('global')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const stats = doc.data();
                            const distribution = stats.personality_distribution || {};
                            
                            // 計算最常見和最稀有的人格類型
                            const sortedTypes = Object.entries(distribution)
                                .sort((a, b) => b[1] - a[1]);
                            
                            const mostCommon = sortedTypes[0] ? personalityTypes[sortedTypes[0][0]]?.name : 'AI效率王';
                            const rarest = sortedTypes[sortedTypes.length - 1] ? personalityTypes[sortedTypes[sortedTypes.length - 1][0]]?.name : 'AI學者';
                            
                            updateStatsUI({
                                total_users: stats.total_users,
                                most_common: mostCommon,
                                rarest: rarest,
                                online_now: Math.floor(stats.total_users * 0.15)
                            });
                        }
                    }, (error) => {
                        console.error('即時統計更新失敗:', error);
                        // 降級到模擬模式
                        updateConnectionStatus('demo');
                        simulateStats();
                    });
            } catch (error) {
                console.error('設置即時統計失敗:', error);
                updateConnectionStatus('demo');
                simulateStats();
            }
        }

        // ===============================
        // 測驗流程（改進選擇動畫）
        // ===============================

        function startTest() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('請填寫暱稱才能開始測驗！');
                document.getElementById('username').focus();
                return;
            }

            currentQuestion = 0;
            answers = {};
            startTime = Date.now();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                calculatePersonality();
                return;
            }

            const question = questions[currentQuestion];
            const container = document.getElementById('questionContainer');
            
            // 添加切換動畫
            container.classList.add('changing');
            
            setTimeout(() => {
                container.innerHTML = `
                    <div class="question-number">問題 ${currentQuestion + 1}</div>
                    <h2 class="question-title">${question.title}</h2>
                    <div class="options-grid">
                        ${question.options.map((option, index) => `
                            <div class="option-card" onclick="selectOption('${option.type}', this)">
                                <div class="option-label">${option.label}</div>
                                <div class="option-description">${option.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.classList.remove('changing');
                updateProgress();
            }, 200);
        }

        function selectOption(type, element) {
            // 防止重複點擊
            if (element.classList.contains('selected') || element.classList.contains('loading')) {
                return;
            }

            answers[currentQuestion] = type;
            
            // 立即顯示選中狀態和loading
            const options = document.querySelectorAll('.option-card');
            options.forEach(option => {
                option.classList.remove('selected');
                option.style.pointerEvents = 'none'; // 防止其他選項被點擊
            });
            
            element.classList.add('selected', 'loading');
            
            // 顯示下一題loading提示
            const loadingElement = document.getElementById('nextQuestionLoading');
            loadingElement.classList.add('show');
            
            // 減少延遲時間並加上動畫
            setTimeout(() => {
                loadingElement.classList.remove('show');
                currentQuestion++;
                loadQuestion();
            }, 600); // 從800ms減少到600ms
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `問題 ${currentQuestion + 1} / ${questions.length}`;
        }

        async function calculatePersonality() {
            // 計算AI人格類型
            const typeCounts = {};
            Object.values(answers).forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            // 找出最多的類型
            const dominantType = Object.keys(typeCounts).reduce((a, b) => 
                typeCounts[a] > typeCounts[b] ? a : b
            );

            const userData = {
                username: document.getElementById('username').value.trim(),
                location: document.getElementById('location').value || '未知',
                occupation: document.getElementById('occupation').value || '未知', 
                age_group: document.getElementById('ageGroup').value || '未知',
                personality_type: dominantType,
                type_scores: typeCounts,
                answers: answers
            };

            showLoading('正在分析你的AI人格特質...');
            
            const result = await submitPersonalityResult(userData);
            
            hideLoading();
            
            userResult = {
                ...userData,
                ...result
            };
            
            showPersonalityResult(dominantType, result);
        }

        async function showPersonalityResult(personalityType, result) {
            const personality = personalityTypes[personalityType];
            
            document.getElementById('testContainer').style.display = 'none';
            
            // 設定人格徽章和基本資訊
            document.getElementById('personalityBadge').textContent = personality.icon;
            document.getElementById('resultTitle').textContent = personality.name;
            document.getElementById('resultSubtitle').textContent = personality.subtitle;
            document.getElementById('resultDescription').textContent = personality.description;
            
            // 設定特質星級
            setTraitStars('innovation', personality.traits.innovation);
            setTraitStars('efficiency', personality.traits.efficiency);
            setTraitStars('creativity', personality.traits.creativity);
            setTraitStars('understanding', personality.traits.understanding);
            
            // 先顯示載入中的統計資訊
            document.getElementById('sameTypeCount').textContent = '載入中...';
            document.getElementById('personalityPercent').textContent = '載入中...';
            document.getElementById('personalityRarity').textContent = '載入中...';
            
            document.getElementById('resultContainer').classList.add('show');
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
            
            createCelebration();
            
            // 異步載入真實統計資訊
            await displayResultStats(personalityType, result);
        }

        async function displayResultStats(personalityType, result) {
            // 嘗試獲取真實的分佈數據
            let realStats = null;
            let typePercentage, sameTypeCount, rarity, dataSource;
            
            if (firebaseInitialized && connectionMode === 'online') {
                try {
                    realStats = await getRealPersonalityDistribution();
                    console.log('獲取到真實統計數據:', realStats); // Debug用
                } catch (error) {
                    console.error('獲取真實統計失敗:', error);
                }
            }
            
            if (realStats && realStats.totalUsers > 0) {
                // 使用真實數據
                const typeCount = realStats.distribution[personalityType] || 0;
                typePercentage = realStats.totalUsers > 0 ? Math.round((typeCount / realStats.totalUsers) * 100) : 0;
                sameTypeCount = typeCount;
                rarity = getRarityLevel(typePercentage);
                dataSource = 'real';
                
                console.log(`真實數據 - ${personalityType}: ${typeCount}人 (${typePercentage}%)`); // Debug用
            } else {
                // 使用模擬數據
                typePercentage = getPersonalityPercentage(personalityType);
                sameTypeCount = Math.floor((result.totalUsers || 15847) * typePercentage / 100);
                rarity = getRarityLevel(typePercentage);
                dataSource = 'simulated';
                
                console.log(`模擬數據 - ${personalityType}: ${sameTypeCount}人 (${typePercentage}%)`); // Debug用
            }
            
            // 添加載入動畫
            const elements = ['sameTypeCount', 'personalityPercent', 'personalityRarity'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                element.style.opacity = '0.6';
                element.style.transform = 'scale(0.9)';
            });
            
            setTimeout(() => {
                document.getElementById('sameTypeCount').textContent = sameTypeCount.toLocaleString();
                document.getElementById('personalityPercent').textContent = `${typePercentage}%`;
                document.getElementById('personalityRarity').textContent = rarity;
                
                // 恢復動畫
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    element.style.opacity = '1';
                    element.style.transform = 'scale(1)';
                    element.style.transition = 'all 0.3s ease';
                });
                
                // 顯示數據來源標示
                updateDataSourceLabel(dataSource, realStats?.totalUsers || 0);
            }, 500);
        }
        
        function updateDataSourceLabel(dataSource, totalUsers = 0) {
            const statsContainer = document.querySelector('.global-stats');
            const existingLabel = statsContainer.querySelector('.data-source-label');
            if (existingLabel) existingLabel.remove();
            
            const dataLabel = document.createElement('div');
            dataLabel.className = 'data-source-label';
            dataLabel.style.cssText = `
                text-align: center;
                margin-top: 15px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 10px;
                font-size: 12px;
                color: #666;
                border: 1px solid rgba(102, 126, 234, 0.2);
            `;
            
            if (dataSource === 'real') {
                dataLabel.innerHTML = `
                    <strong>📊 真實數據統計</strong><br>
                    <span style="color: #888; font-size: 11px;">基於 ${totalUsers.toLocaleString()} 位真實用戶的測驗結果</span>
                `;
            } else {
                dataLabel.innerHTML = `
                    <strong>🎯 演示數據</strong><br>
                    <span style="color: #888; font-size: 11px;">基於模擬統計，僅供參考</span>
                `;
            }
            
            statsContainer.appendChild(dataLabel);
        }

        async function getRealPersonalityDistribution() {
            if (!firebaseInitialized || connectionMode !== 'online') {
                throw new Error('Firebase未初始化或非線上模式');
            }
            
            const doc = await db.collection('personality_stats').doc('global').get();
            
            if (!doc.exists) {
                throw new Error('統計文檔不存在');
            }
            
            const data = doc.data();
            return {
                totalUsers: data.total_users || 0,
                distribution: data.personality_distribution || {}
            };
        }

        function getRarityLevel(percentage) {
            if (percentage >= 30) return '常見';
            if (percentage >= 20) return '普通';
            if (percentage >= 15) return '少見';
            return '稀有';
        }

        function setTraitStars(traitId, level) {
            const container = document.getElementById(`${traitId}-stars`);
            container.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = i <= level ? 'star' : 'star empty';
                star.textContent = '★';
                container.appendChild(star);
            }
        }

        function getPersonalityPercentage(type) {
            // 模擬數據的固定百分比
            const percentages = {
                pioneer: 23,
                creator: 28,
                efficiency: 31,
                scholar: 18
            };
            return percentages[type] || 25;
        }

        // ===============================
        // 資料庫操作
        // ===============================

        async function submitPersonalityResult(userData) {
            // 如果是離線模式，不保存數據
            if (connectionMode === 'offline') {
                return {
                    success: false,
                    totalUsers: 0,
                    userId: 'offline_mode',
                    message: '離線模式，數據未保存'
                };
            }
            
            // 如果不是線上模式，使用模擬數據
            if (!firebaseInitialized || connectionMode !== 'online') {
                return {
                    success: true,
                    totalUsers: 15847,
                    userId: 'demo_' + Date.now(),
                    message: '演示模式'
                };
            }

            try {
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const testData = {
                    ...userData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ip_hash: await hashIP(await getUserIP()),
                    user_agent: navigator.userAgent,
                    test_duration: Math.floor((Date.now() - startTime) / 1000)
                };
                
                await db.collection('personality_rankings').doc(userId).set(testData);
                const totalUsers = await updateGlobalStatsInDB(testData);
                
                return { success: true, totalUsers: totalUsers, userId: userId };
            } catch (error) {
                console.error('儲存失敗:', error);
                
                // 降級到演示模式
                updateConnectionStatus('demo');
                
                return { 
                    success: false, 
                    error: error.message,
                    totalUsers: 15847,
                    userId: 'error_' + Date.now()
                };
            }
        }

        async function updateGlobalStatsInDB(userData) {
            if (!firebaseInitialized || connectionMode !== 'online') return 15847;
            
            try {
                const statsRef = db.collection('personality_stats').doc('global');
                let totalUsers = 15847;
                
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(statsRef);
                    
                    if (!doc.exists) {
                        transaction.set(statsRef, {
                            total_users: 1,
                            personality_distribution: {
                                [userData.personality_type]: 1
                            },
                            last_updated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        totalUsers = 1;
                    } else {
                        const currentStats = doc.data();
                        totalUsers = (currentStats.total_users || 0) + 1;
                        transaction.update(statsRef, {
                            total_users: firebase.firestore.FieldValue.increment(1),
                            [`personality_distribution.${userData.personality_type}`]: firebase.firestore.FieldValue.increment(1),
                            last_updated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                return totalUsers;
            } catch (error) {
                console.error('更新統計失敗:', error);
                return 15847;
            }
        }

        // ===============================
        // 人格分佈統計功能（取代原本的排行榜）
        // ===============================

        async function showPersonalityStats() {
            if (pendingStatsRequest) return;
            pendingStatsRequest = true;
            
            document.getElementById('personalityStatsSection').style.display = 'block';
            document.getElementById('personalityStatsSection').scrollIntoView({ behavior: 'smooth' });
            
            const content = document.getElementById('personalityStatsContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>載入統計數據中...</p>
                </div>
            `;
            
            try {
                let statsData;
                
                if (firebaseInitialized && connectionMode === 'online') {
                    // 嘗試從Firebase載入真實數據
                    statsData = await loadRealPersonalityStats();
                } else if (connectionMode === 'demo') {
                    // 使用模擬數據
                    await new Promise(resolve => setTimeout(resolve, 1500)); // 模擬載入時間
                    statsData = generateMockPersonalityStats();
                } else {
                    // 離線模式
                    throw new Error('離線模式無法載入統計數據');
                }
                
                displayPersonalityStats(statsData);
                
            } catch (error) {
                console.error('載入統計數據失敗:', error);
                showStatsError(error.message);
            } finally {
                pendingStatsRequest = false;
            }
        }

        async function loadRealPersonalityStats() {
            try {
                const doc = await db.collection('personality_stats').doc('global').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const distribution = data.personality_distribution || {};
                    const totalUsers = data.total_users || 0;
                    
                    // 轉換數據格式
                    const stats = Object.entries(personalityTypes).map(([key, personality]) => {
                        const count = distribution[key] || 0;
                        const percentage = totalUsers > 0 ? Math.round((count / totalUsers) * 100) : 0;
                        
                        return {
                            type: key,
                            ...personality,
                            count: count,
                            percentage: percentage
                        };
                    });
                    
                    // 按人數排序
                    stats.sort((a, b) => b.count - a.count);
                    
                    return {
                        totalUsers: totalUsers,
                        personalities: stats
                    };
                } else {
                    throw new Error('無統計數據');
                }
            } catch (error) {
                console.error('讀取真實統計數據失敗:', error);
                throw error;
            }
        }

        function generateMockPersonalityStats() {
            const mockDistribution = {
                efficiency: 4850,  // 31%
                creator: 4380,     // 28%
                pioneer: 3600,     // 23%
                scholar: 2817      // 18%
            };
            
            const totalUsers = Object.values(mockDistribution).reduce((a, b) => a + b, 0);
            
            const stats = Object.entries(personalityTypes).map(([key, personality]) => {
                const count = mockDistribution[key] || 0;
                const percentage = Math.round((count / totalUsers) * 100);
                
                return {
                    type: key,
                    ...personality,
                    count: count,
                    percentage: percentage
                };
            });
            
            // 按人數排序
            stats.sort((a, b) => b.count - a.count);
            
            return {
                totalUsers: totalUsers,
                personalities: stats
            };
        }

        function displayPersonalityStats(statsData) {
            const content = document.getElementById('personalityStatsContent');
            
            if (!statsData || !statsData.personalities || statsData.personalities.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
                        <h3 style="color: #666; margin-bottom: 15px;">暫無統計數據</h3>
                        <p style="color: #999;">成為第一個完成測驗的人吧！</p>
                    </div>
                `;
                return;
            }
            
            const maxPercentage = Math.max(...statsData.personalities.map(p => p.percentage));
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <p style="color: #666; font-size: 16px;">
                        基於 <strong>${statsData.totalUsers.toLocaleString()}</strong> 人的測驗結果
                    </p>
                </div>
                
                <div class="personality-distribution">
                    ${statsData.personalities.map((personality, index) => {
                        const barWidth = maxPercentage > 0 ? (personality.percentage / maxPercentage) * 100 : 0;
                        const isUserType = userResult && userResult.personality_type === personality.type;
                        
                        return `
                            <div class="personality-stat-item" style="${isUserType ? 'background: linear-gradient(135deg, #e3f2fd, #f0f8ff); border: 2px solid #2196f3;' : ''}">
                                <div class="personality-stat-icon">${personality.icon}</div>
                                <div class="personality-stat-info">
                                    <div class="personality-stat-name">
                                        ${personality.name} ${isUserType ? '(你的類型)' : ''}
                                    </div>
                                    <div class="personality-stat-subtitle">${personality.subtitle}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                        ${personality.count.toLocaleString()} 人
                                    </div>
                                </div>
                                <div class="personality-stat-bar">
                                    <div class="personality-stat-fill" style="width: ${barWidth}%"></div>
                                </div>
                                <div class="personality-stat-percent">${personality.percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                    <p style="color: #666; font-size: 14px;">
                        ✨ <strong>每種AI人格都有其獨特價值！</strong><br>
                        這些統計數據反映了不同的AI使用風格和偏好，<br>
                        沒有優劣之分，只有不同的特色和優勢。
                    </p>
                </div>
            `;
            
            // 動畫效果
            setTimeout(() => {
                const fills = document.querySelectorAll('.personality-stat-fill');
                fills.forEach(fill => {
                    const width = fill.style.width;
                    fill.style.width = '0%';
                    setTimeout(() => {
                        fill.style.width = width;
                    }, 100);
                });
            }, 200);
        }

        function showStatsError(errorMessage) {
            const content = document.getElementById('personalityStatsContent');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">載入失敗</h3>
                    <p style="color: #666; margin-bottom: 20px;">無法載入統計數據</p>
                    <small style="color: #999;">錯誤詳情: ${errorMessage}</small>
                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="showStatsFallbackDialog()" style="font-size: 14px; padding: 12px 24px;">
                            顯示演示數據
                        </button>
                    </div>
                </div>
            `;
        }

        function showStatsFallbackDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'error-dialog';
            dialog.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">📊</div>
                    <div class="error-title">統計數據載入失敗</div>
                    <div class="error-message">
                        無法從服務器載入統計數據。<br><br>
                        是否要顯示演示統計數據？<br>
                        <small style="color: #666;">演示數據僅供參考，不代表真實統計。</small>
                    </div>
                    <div class="error-buttons">
                        <button class="btn-confirm" onclick="showDemoStats()">是，顯示演示數據</button>
                        <button class="btn-cancel" onclick="cancelStats()">否，返回結果頁面</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function showDemoStats() {
            document.querySelector('.error-dialog')?.remove();
            const demoData = generateMockPersonalityStats();
            displayPersonalityStats(demoData);
        }

        function cancelStats() {
            document.querySelector('.error-dialog')?.remove();
            hidePersonalityStats();
        }

        function hidePersonalityStats() {
            document.getElementById('personalityStatsSection').style.display = 'none';
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // ===============================
        // 輔助函數
        // ===============================

        function shareResult() {
            if (!userResult) return;
            
            const personality = personalityTypes[userResult.personality_type];
            const percentage = getPersonalityPercentage(userResult.personality_type);
            const shareText = `我剛完成了AI人格特質測驗！

🎯 我的AI人格：${personality.name}
${personality.subtitle}
🦅 我的AI夥伴：${personality.animal}
📊 全球佔比：${percentage}%

你的AI人格是什麼？快來測試看看！

由 Nick Chang | ZN Studio 創作
Nick Chang｜nickleo051216@gmail.com｜0932-684-051
#AI人格測驗 #${personality.name} #人工智慧`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AI人格特質測驗結果',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    showNotification('結果已複製到剪貼簿！快去分享你的AI人格吧 🎉');
                });
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        async function hashIP(ip) {
            const encoder = new TextEncoder();
            const data = encoder.encode(ip + 'ai-personality-salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p style="color: #666; margin: 0;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function createCelebration() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.innerHTML = ['🎉', '✨', '🎊', '⭐'][Math.floor(Math.random() * 4)];
                    confetti.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}vw;
                        top: -10px;
                        font-size: 20px;
                        z-index: 1000;
                        pointer-events: none;
                        animation: fall ${Math.random() * 3 + 2}s linear forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 100);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
                animation: slideInRight 0.5s ease forwards;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // ===============================
        // 初始化
        // ===============================

        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        // 添加動畫CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 防止測驗進行中離開頁面
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                e.preventDefault();
                e.returnValue = '你的測驗進度將會遺失，確定要離開嗎？';
            }
        });

        // 全域函數（供HTML onclick調用）
        window.startTest = startTest;
        window.selectOption = selectOption;
        window.shareResult = shareResult;
        window.showPersonalityStats = showPersonalityStats;
        window.hidePersonalityStats = hidePersonalityStats;
        window.useDemoMode = useDemoMode;
        window.useOfflineMode = useOfflineMode;
        window.showDemoStats = showDemoStats;
        window.cancelStats = cancelStats;
        window.showStatsFallbackDialog = showStatsFallbackDialog;
    </script>
</body>
</html>
