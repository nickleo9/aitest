<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIäººæ ¼ç‰¹è³ªæ¸¬é©— - ç™¼ç¾ä½ çš„AIäººæ ¼é¡å‹</title>
    <meta name="description" content="å…¨çƒé¦–å‰µAIäººæ ¼ç‰¹è³ªæ¸¬é©—ï¼Œç™¼ç¾ä½ æ˜¯å“ªç¨®AIäººæ ¼é¡å‹ï¼">
    <meta property="og:title" content="AIäººæ ¼ç‰¹è³ªæ¸¬é©— - ä½ æ˜¯AIå…ˆé‹’è€…é‚„æ˜¯AIå­¸è€…ï¼Ÿ">
    <meta property="og:description" content="3åˆ†é˜ç™¼ç¾ä½ çš„AIäººæ ¼ç‰¹è³ªï¼Œäº†è§£å…¨çƒåˆ†ä½ˆï¼">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/667eea/ffffff?text=AI%E4%BA%BA%E6%A0%BC%E7%89%B9%E8%B3%AA%E6%B8%AC%E9%A9%97">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .hero-section {
            text-align: center;
            padding: 60px 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 200% 100%;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .hero-title {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .personality-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
        }

        .personality-type {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .personality-type:hover {
            transform: translateY(-3px);
        }

        .personality-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .personality-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .creator-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .creator-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .test-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            position: relative;
            overflow: hidden;
        }

        .user-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-container {
            margin-bottom: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .question-container {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.4s ease;
        }

        .question-container.changing {
            opacity: 0;
            transform: translateX(30px);
        }

        .question-number {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.3;
        }

        .options-grid {
            display: grid;
            gap: 15px;
            margin: 30px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e8ecf4;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.02);
        }

        /* æ–°å¢ï¼šé¸æ“‡å¾Œçš„loadingç‹€æ…‹ */
        .option-card.loading {
            position: relative;
            pointer-events: none;
        }

        .option-card.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 20px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translateY(-50%);
        }

        .option-label {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .option-description {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* ä¸‹ä¸€é¡Œloadingæç¤º */
        .next-question-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .next-question-loading.show {
            opacity: 1;
        }

        .next-question-loading .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .result-container.show {
            display: block;
            animation: resultAppear 0.8s ease forwards;
        }

        @keyframes resultAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .personality-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 120px;
            font-size: 48px;
            margin-bottom: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }

        .result-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-subtitle {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .result-description {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .personality-traits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .trait-card {
            background: rgba(102, 126, 234, 0.1);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .trait-name {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .trait-stars {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .star {
            color: #ffd700;
            font-size: 20px;
            margin: 0 2px;
        }

        .star.empty {
            color: #ddd;
        }

        /* ä¿®æ”¹ï¼šå…¨çƒçµ±è¨ˆï¼ˆä¸æ˜¯æ’åï¼‰ */
        .global-stats {
            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            border: 2px solid #2196f3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-big-number {
            font-size: 32px;
            font-weight: 800;
            color: #2196f3;
            margin-bottom: 5px;
        }

        .stat-description {
            font-size: 14px;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 15px 40px rgba(240, 147, 251, 0.4);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ä¿®æ”¹ï¼šäººæ ¼åˆ†ä½ˆçµ±è¨ˆï¼ˆå–ä»£æ’è¡Œæ¦œï¼‰ */
        .personality-stats-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            display: none;
        }

        .personality-distribution {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .personality-stat-item {
            display: flex;
            align-items: center;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .personality-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .personality-stat-icon {
            font-size: 48px;
            margin-right: 25px;
            width: 80px;
            text-align: center;
        }

        .personality-stat-info {
            flex-grow: 1;
        }

        .personality-stat-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .personality-stat-subtitle {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .personality-stat-bar {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-right: 20px;
        }

        .personality-stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .personality-stat-percent {
            font-size: 24px;
            font-weight: 800;
            color: #667eea;
            min-width: 60px;
            text-align: center;
        }

        .error-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .error-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .error-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .error-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .connection-status.offline {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .connection-status.demo {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 36px;
            }
            
            .test-container, .result-container {
                padding: 30px 20px;
                margin: 20px 0;
                border-radius: 20px;
            }
            
            .question-title {
                font-size: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .personality-traits {
                grid-template-columns: 1fr;
            }

            .error-content {
                margin: 20px;
                padding: 30px 20px;
            }

            .error-buttons {
                flex-direction: column;
            }

            .personality-stat-item {
                flex-direction: column;
                text-align: center;
            }

            .personality-stat-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .personality-stat-bar {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <!-- é€£æ¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connectionStatus">é€£æ¥ä¸­...</div>

    <div class="container">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <div class="hero-section">
            <h1 class="hero-title">ğŸ§  AIäººæ ¼ç‰¹è³ªæ¸¬é©—</h1>
            <p class="hero-subtitle">ç™¼ç¾ä½ ç¨ç‰¹çš„AIäººæ ¼é¡å‹</p>
            <p style="color: #888; margin-bottom: 20px;">
                3åˆ†é˜äº†è§£ä½ çš„AIä½¿ç”¨äººæ ¼ï¼Œæ‰¾åˆ°å°ˆå±¬çš„AIå¤¥ä¼´é¡å‹ï¼
            </p>
            
            <div class="personality-preview">
                <div class="personality-type">
                    <div class="personality-icon">ğŸš€</div>
                    <div class="personality-name">AIå…ˆé‹’è€…</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">ğŸ¨</div>
                    <div class="personality-name">AIå‰µæ„å®¶</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">âš¡</div>
                    <div class="personality-name">AIæ•ˆç‡ç‹</div>
                </div>
                <div class="personality-type">
                    <div class="personality-icon">ğŸ”¬</div>
                    <div class="personality-name">AIå­¸è€…</div>
                </div>
            </div>
            
            <a href="https://portaly.cc/zn.studio" target="_blank" class="creator-badge">
                <span style="margin-right: 8px;">ğŸ’¡</span>
                ç”± Nick Chang | ZN Studio å‰µä½œ
            </a>
        </div>

        <!-- å³æ™‚çµ±è¨ˆ -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">è¼‰å…¥ä¸­...</div>
                <div class="stat-label">å…¨çƒåƒèˆ‡äººæ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mostCommon">è¼‰å…¥ä¸­...</div>
                <div class="stat-label">æœ€å¸¸è¦‹äººæ ¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rarest">è¼‰å…¥ä¸­...</div>
                <div class="stat-label">æœ€ç¨€æœ‰äººæ ¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineNow">è¼‰å…¥ä¸­...</div>
                <div class="stat-label">ç›®å‰åœ¨ç·š</div>
            </div>
        </div>

        <!-- æ¸¬é©—å€åŸŸ -->
        <div class="test-container" id="testContainer">
            <!-- ç”¨æˆ¶è³‡æ–™è¡¨å–® -->
            <div class="user-form">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                    ğŸ“ è«‹å¡«å¯«åŸºæœ¬è³‡æ–™ä»¥åƒèˆ‡å…¨çƒçµ±è¨ˆ
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">æš±ç¨± *</label>
                        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½ çš„æš±ç¨±" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="location">åœ°å€</label>
                        <select id="location">
                            <option value="">é¸æ“‡åœ°å€ï¼ˆå¯é¸ï¼‰</option>
                            <option value="å°åŒ—">å°åŒ—</option>
                            <option value="æ–°åŒ—">æ–°åŒ—</option>
                            <option value="æ¡ƒåœ’">æ¡ƒåœ’</option>
                            <option value="å°ä¸­">å°ä¸­</option>
                            <option value="å°å—">å°å—</option>
                            <option value="é«˜é›„">é«˜é›„</option>
                            <option value="å…¶ä»–å°ç£åœ°å€">å…¶ä»–å°ç£åœ°å€</option>
                            <option value="é¦™æ¸¯">é¦™æ¸¯</option>
                            <option value="æ–°åŠ å¡">æ–°åŠ å¡</option>
                            <option value="é¦¬ä¾†è¥¿äº">é¦¬ä¾†è¥¿äº</option>
                            <option value="ä¸­åœ‹å¤§é™¸">ä¸­åœ‹å¤§é™¸</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="occupation">è·æ¥­</label>
                        <select id="occupation">
                            <option value="">é¸æ“‡è·æ¥­ï¼ˆå¯é¸ï¼‰</option>
                            <option value="å­¸ç”Ÿ">å­¸ç”Ÿ</option>
                            <option value="å·¥ç¨‹å¸«">å·¥ç¨‹å¸«</option>
                            <option value="è¨­è¨ˆå¸«">è¨­è¨ˆå¸«</option>
                            <option value="è¡ŒéŠ·äººå“¡">è¡ŒéŠ·äººå“¡</option>
                            <option value="å‰µæ¥­è€…">å‰µæ¥­è€…</option>
                            <option value="æ•™å¸«">æ•™å¸«</option>
                            <option value="é†«è­·äººå“¡">é†«è­·äººå“¡</option>
                            <option value="é‡‘èæ¥­">é‡‘èæ¥­</option>
                            <option value="æœå‹™æ¥­">æœå‹™æ¥­</option>
                            <option value="è‡ªç”±å·¥ä½œè€…">è‡ªç”±å·¥ä½œè€…</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ageGroup">å¹´é½¡å±¤</label>
                        <select id="ageGroup">
                            <option value="">é¸æ“‡å¹´é½¡å±¤ï¼ˆå¯é¸ï¼‰</option>
                            <option value="18-24">18-24æ­²</option>
                            <option value="25-34">25-34æ­²</option>
                            <option value="35-44">35-44æ­²</option>
                            <option value="45-54">45-54æ­²</option>
                            <option value="55+">55æ­²ä»¥ä¸Š</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹æ¸¬é©—</div>
            </div>

            <div class="question-container" id="questionContainer">
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">ğŸ§  æ¢ç´¢ä½ çš„AIäººæ ¼ç‰¹è³ª</h2>
                    <p style="color: #666; margin-bottom: 30px;">
                        é€šé8å€‹å•é¡Œï¼Œäº†è§£ä½ èˆ‡AIäº’å‹•çš„ç¨ç‰¹é¢¨æ ¼å’Œåå¥½
                    </p>
                    <button class="btn" onclick="startTest()" style="font-size: 18px; padding: 20px 50px;">
                        ğŸš€ é–‹å§‹æ¢ç´¢
                    </button>
                </div>
            </div>

            <!-- æ–°å¢ï¼šä¸‹ä¸€é¡Œloadingæç¤º -->
            <div class="next-question-loading" id="nextQuestionLoading">
                <div class="spinner-small"></div>
                æº–å‚™ä¸‹ä¸€é¡Œ...
            </div>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div class="result-container" id="resultContainer">
            <div class="personality-badge" id="personalityBadge">ğŸš€</div>
            <h2 class="result-title" id="resultTitle">AIå…ˆé‹’è€…</h2>
            <p class="result-subtitle" id="resultSubtitle">"AIçš„æœªä¾†ï¼Œæˆ‘ä¾†å‰µé€ ï¼"</p>
            <p class="result-description" id="resultDescription">çµæœæè¿°</p>

            <div class="personality-traits">
                <div class="trait-card">
                    <div class="trait-name">å‰µæ–°æ¢ç´¢</div>
                    <div class="trait-stars" id="innovation-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">æ•ˆç‡æå‡</div>
                    <div class="trait-stars" id="efficiency-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">å‰µæ„è¡¨é”</div>
                    <div class="trait-stars" id="creativity-stars"></div>
                </div>
                <div class="trait-card">
                    <div class="trait-name">æ·±åº¦ç†è§£</div>
                    <div class="trait-stars" id="understanding-stars"></div>
                </div>
            </div>

            <!-- ä¿®æ”¹ï¼šå…¨çƒçµ±è¨ˆè³‡è¨Šï¼ˆä¸æ˜¯æ’åï¼‰ -->
            <div class="global-stats">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">ğŸŒ ä½ çš„äººæ ¼ç‰¹è³ªçµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-big-number" id="sameTypeCount">1,247</div>
                        <div class="stat-description">åŒé¡å‹äººæ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-big-number" id="personalityPercent">23%</div>
                        <div class="stat-description">å…¨çƒä½”æ¯”</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-big-number" id="personalityRarity">å¸¸è¦‹</div>
                        <div class="stat-description">ç¨€æœ‰ç¨‹åº¦</div>
                    </div>
                </div>
                <p style="color: #666; font-size: 14px; margin-top: 15px;">
                    æ¯ç¨®AIäººæ ¼éƒ½æœ‰å…¶ç¨ç‰¹åƒ¹å€¼ï¼æ²’æœ‰å„ªåŠ£ä¹‹åˆ†ï¼Œåªæœ‰ä¸åŒçš„ç‰¹è‰²å’Œå„ªå‹¢ âœ¨
                </p>
            </div>

            <div style="margin: 40px 0;">
                <button class="btn" onclick="shareResult()">
                    ğŸ“¤ åˆ†äº«æˆ‘çš„AIäººæ ¼
                </button>
                <button class="btn btn-secondary" onclick="showPersonalityStats()">
                    ğŸ“Š æŸ¥çœ‹äººæ ¼åˆ†ä½ˆçµ±è¨ˆ
                </button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    <strong>æƒ³äº†è§£æ›´å¤šAIäººæ ¼ç‰¹è³ªï¼Ÿ</strong><br>
                    Nick Changï½œnickleo051216@gmail.comï½œ0932-684-051<br>
                    å€‹äººç¶²ç«™ï¼šZN Studioï½œ<a href="https://portaly.cc/zn.studio" target="_blank" style="color: #667eea;">https://portaly.cc/zn.studio</a><br>
                    Threadsï¼š ZN Studio ( @nickai216 )  <a href="https://www.threads.com/@nickai216" target="_blank" style="color: #667eea;">https://www.threads.com/@nickai216</a><br>
                    Line ç¤¾ç¾¤ï¼š<a href="https://reurl.cc/1OZNAY" target="_blank" style="color: #667eea;">https://reurl.cc/1OZNAY</a><br>
                    Line ï¼š <a href="https://lin.ee/Faz0doj" target="_blank" style="color: #667eea;">https://lin.ee/Faz0doj</a>
                </p>
                <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                    åŠ å…¥Nick Changçš„Lineç¤¾ç¾¤ï¼Œèˆ‡åŒé¡å‹å¤¥ä¼´äº¤æµï¼
                </p>
                <a href="https://reurl.cc/1OZNAY" target="_blank" class="btn" style="font-size: 14px; padding: 12px 24px;">
                    ğŸ¯ åŠ å…¥AIäººæ ¼ç¤¾ç¾¤
                </a>
            </div>
        </div>

        <!-- ä¿®æ”¹ï¼šäººæ ¼åˆ†ä½ˆçµ±è¨ˆå€åŸŸï¼ˆå–ä»£æ’è¡Œæ¦œï¼‰ -->
        <div class="personality-stats-section" id="personalityStatsSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">ğŸ“Š å…¨çƒAIäººæ ¼åˆ†ä½ˆçµ±è¨ˆ</h2>
            <div id="personalityStatsContent">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥çµ±è¨ˆæ•¸æ“šä¸­...</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="hidePersonalityStats()">è¿”å›çµæœ</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // å…¨åŸŸè®Šæ•¸å’Œè¨­å®š
        // ===============================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAqwdMVnhrj0Ktj9BTEOVJdpzBLPpMaTq",
            authDomain: "ai-level-test.firebaseapp.com", 
            projectId: "ai-level-test",
            storageBucket: "ai-level-test.firebasestorage.app",
            messagingSenderId: "774029966921",
            appId: "1:774029966921:web:5bceaeb011e665f4ccc40c",
            measurementId: "G-TH0M0VXRZC"
        };

        let db = null;
        let firebaseInitialized = false;
        let connectionMode = 'connecting'; // connecting, online, offline, demo
        let currentQuestion = 0;
        let answers = {};
        let startTime = Date.now();
        let userResult = null;
        let pendingStatsRequest = false;

        // AIäººæ ¼é¡å‹å®šç¾©
        const personalityTypes = {
            pioneer: {
                icon: 'ğŸš€',
                name: 'AIå…ˆé‹’è€…',
                subtitle: '"AIçš„æœªä¾†ï¼Œæˆ‘ä¾†å‰µé€ ï¼"',
                animal: 'é›„é·¹ ğŸ¦…',
                description: 'ä½ ç¸½æ˜¯ç¬¬ä¸€å€‹æ¥è§¸æ–°AIæŠ€è¡“çš„äººï¼å…·æœ‰å¼·çƒˆçš„æ¢ç´¢ç²¾ç¥å’Œå‰µæ–°æ€ç¶­ï¼Œå–œæ­¡å˜—è©¦å„ç¨®å‰æ²¿AIå·¥å…·ï¼Œä¸¦èƒ½æ•éŠ³åœ°æ´å¯ŸAIç™¼å±•è¶¨å‹¢ã€‚ä½ ä¸åƒ…æ˜¯AIçš„ä½¿ç”¨è€…ï¼Œæ›´æ˜¯AIæ™‚ä»£çš„å¼•é ˜è€…ï¼Œç”¨ä½ çš„ç†±æƒ…å’Œé è¦‹å½±éŸ¿è‘—å‘¨åœçš„äººã€‚',
                traits: {
                    innovation: 5,
                    efficiency: 4,
                    creativity: 4,
                    understanding: 3
                }
            },
            creator: {
                icon: 'ğŸ¨',
                name: 'AIå‰µæ„å®¶',
                subtitle: '"AIæ˜¯æˆ‘çš„å‰µæ„å¤¥ä¼´ï¼"',
                animal: 'è´è¶ ğŸ¦‹',
                description: 'ä½ æ“æœ‰è±å¯Œçš„æƒ³åƒåŠ›å’Œå‰µé€ åŠ›ï¼å–„æ–¼é‹ç”¨AIé€²è¡Œè—è¡“å‰µä½œã€å…§å®¹ç”Ÿæˆå’Œå‰µæ„è¡¨é”ã€‚ä½ å°‡AIè¦–ç‚ºå‰µæ„çš„å»¶ä¼¸ï¼Œèƒ½å¤ èˆ‡AIå”ä½œç”¢å‡ºä»¤äººé©šè‰·çš„ä½œå“ã€‚ä½ çš„å‰µä½œç¸½æ˜¯å……æ»¿å€‹æ€§å’Œæ„ŸæŸ“åŠ›ï¼Œæ¿€ç™¼ä»–äººçš„å‰µæ„éˆæ„Ÿã€‚',
                traits: {
                    innovation: 4,
                    efficiency: 3,
                    creativity: 5,
                    understanding: 3
                }
            },
            efficiency: {
                icon: 'âš¡',
                name: 'AIæ•ˆç‡ç‹',
                subtitle: '"æ•ˆç‡å°±æ˜¯ç”Ÿç”¢åŠ›ï¼"',
                animal: 'çµè±¹ ğŸ†',
                description: 'ä½ æ˜¯è¿½æ±‚æ•ˆç‡å’Œçµæœçš„å¯¦è¸è€…ï¼å°ˆæ³¨æ–¼é‹ç”¨AIå·¥å…·æå‡å·¥ä½œå’Œå­¸ç¿’æ•ˆç‡ï¼Œèƒ½å¤ å¿«é€Ÿæ‰¾åˆ°æœ€é©åˆçš„AIè§£æ±ºæ–¹æ¡ˆã€‚ä½ çš„æ™‚é–“ç®¡ç†èƒ½åŠ›æ¥µå¼·ï¼Œç¸½æ˜¯èƒ½ç”¨æœ€çŸ­çš„æ™‚é–“é”æˆæœ€ä½³æ•ˆæœã€‚ä½ æ˜¯è·å ´ä¸Šçš„AIæ•ˆç‡å°ˆå®¶ã€‚',
                traits: {
                    innovation: 3,
                    efficiency: 5,
                    creativity: 3,
                    understanding: 4
                }
            },
            scholar: {
                icon: 'ğŸ”¬',
                name: 'AIå­¸è€…',
                subtitle: '"çŸ¥è­˜å°±æ˜¯åŠ›é‡ï¼"',
                animal: 'è²“é ­é·¹ ğŸ¦‰',
                description: 'ä½ æ˜¯AIé ˜åŸŸçš„æ·±åº¦æ€è€ƒè€…ï¼å–œæ­¡æ¢ç©¶AIçš„å·¥ä½œåŸç†å’ŒæŠ€è¡“ç´°ç¯€ï¼Œå…·æœ‰å¼·çƒˆçš„æ±‚çŸ¥æ…¾å’Œå­¸ç¿’èƒ½åŠ›ã€‚ä½ é‡è¦–çŸ¥è­˜çš„æº–ç¢ºæ€§å’Œæ·±åº¦ï¼Œèƒ½å¤ ç†æ€§åˆ†æAIçš„å„ªåŠ£å‹¢ã€‚ä½ çš„è¦‹è§£ç¸½æ˜¯æ·±åˆ»è€Œæœ‰åƒ¹å€¼ï¼Œæ˜¯ä»–äººå­¸ç¿’AIçš„å¯é å°å¸«ã€‚',
                traits: {
                    innovation: 3,
                    efficiency: 4,
                    creativity: 3,
                    understanding: 5
                }
            }
        };

        // é‡æ–°è¨­è¨ˆçš„å•é¡Œåº«ï¼ˆAIäººæ ¼å°å‘ï¼‰
        const questions = [
            {
                title: "ä½ æœ€åˆé–‹å§‹ä½¿ç”¨AIæ˜¯å› ç‚ºï¼Ÿ",
                options: [
                    { label: "ğŸš€ è½èªªå¾ˆé…·ï¼Œæƒ³å˜—è©¦æ–°ç§‘æŠ€", desc: "å°æ–°äº‹ç‰©å……æ»¿å¥½å¥‡ï¼Œå–œæ­¡æ¢ç´¢å‰æ²¿æŠ€è¡“", type: 'pioneer' },
                    { label: "ğŸ¨ æƒ³è¦å¯¦ç¾å‰µæ„æƒ³æ³•", desc: "å¸Œæœ›ç”¨AIä¾†è¼”åŠ©å‰µä½œå’Œè¡¨é”", type: 'creator' },
                    { label: "âš¡ å·¥ä½œéœ€è¦ï¼Œæå‡æ•ˆç‡", desc: "ç‚ºäº†è§£æ±ºå¯¦éš›å•é¡Œï¼Œæé«˜å·¥ä½œæ•ˆç‡", type: 'efficiency' },
                    { label: "ğŸ”¬ æƒ³æ·±å…¥äº†è§£AIåŸç†", desc: "å°AIæŠ€è¡“æœ¬èº«æ„Ÿèˆˆè¶£ï¼Œæƒ³å­¸ç¿’çŸ¥è­˜", type: 'scholar' }
                ]
            },
            {
                title: "é¢å°æ–°çš„AIå·¥å…·ï¼Œä½ é€šå¸¸æœƒï¼Ÿ",
                options: [
                    { label: "ğŸ¯ é¦¬ä¸Šä¸‹è¼‰è©¦ç”¨", desc: "ç«‹å³å˜—è©¦ï¼Œé‚Šç”¨é‚Šå­¸", type: 'pioneer' },
                    { label: "ğŸ¨ æƒ³åƒå‰µä½œå¯èƒ½æ€§", desc: "æ€è€ƒèƒ½ç”¨å®ƒå‰µé€ ä»€éº¼æœ‰è¶£çš„ä½œå“", type: 'creator' },
                    { label: "ğŸ“Š è©•ä¼°å¯¦ç”¨åƒ¹å€¼", desc: "åˆ†æå®ƒèƒ½ç‚ºå·¥ä½œå¸¶ä¾†ä»€éº¼å¹«åŠ©", type: 'efficiency' },
                    { label: "ğŸ“š å…ˆç ”ç©¶æŠ€è¡“æ–‡æª”", desc: "äº†è§£åŸç†å’ŒåŠŸèƒ½å¾Œå†ä½¿ç”¨", type: 'scholar' }
                ]
            },
            {
                title: "ä½ æœ€å–œæ­¡ç”¨AIåšä»€éº¼ï¼Ÿ",
                options: [
                    { label: "ğŸ”¬ æ¢ç´¢å„ç¨®å¯èƒ½æ€§", desc: "å˜—è©¦AIçš„å„ç¨®åŠŸèƒ½å’Œæ‡‰ç”¨å ´æ™¯", type: 'pioneer' },
                    { label: "ğŸ­ å‰µä½œå’Œè¡¨é”æƒ³æ³•", desc: "ç”¨AIé€²è¡Œè—è¡“å‰µä½œã€å…§å®¹ç”Ÿæˆ", type: 'creator' },
                    { label: "ğŸ“ˆ è§£æ±ºå·¥ä½œå•é¡Œ", desc: "ç”¨AIè™•ç†æ—¥å¸¸ä»»å‹™ï¼Œæå‡æ•ˆç‡", type: 'efficiency' },
                    { label: "ğŸ“– å­¸ç¿’å’Œç ”ç©¶", desc: "ç”¨AIè¼”åŠ©å­¸ç¿’ï¼Œæ·±å…¥ç†è§£çŸ¥è­˜", type: 'scholar' }
                ]
            },
            {
                title: "ç•¶ä½ ç™¼ç¾AIçš„æ–°åŠŸèƒ½æ™‚ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { label: "ğŸ“¢ ç«‹å³åˆ†äº«çµ¦æœ‹å‹", desc: "èˆˆå¥®åœ°å‘Šè¨´å¤§å®¶é€™å€‹ç™¼ç¾", type: 'pioneer' },
                    { label: "ğŸ’¡ æ€è€ƒå‰µä½œéˆæ„Ÿ", desc: "è€ƒæ…®å¦‚ä½•ç”¨æ–¼è‡ªå·±çš„å‰µä½œ", type: 'creator' },
                    { label: "ğŸ¯ è©•ä¼°å·¥ä½œæ‡‰ç”¨", desc: "åˆ†æå¦‚ä½•æ‡‰ç”¨åˆ°å¯¦éš›å·¥ä½œä¸­", type: 'efficiency' },
                    { label: "ğŸ” æ·±å…¥ç ”ç©¶ç´°ç¯€", desc: "è©³ç´°äº†è§£åŠŸèƒ½åŸç†å’Œé™åˆ¶", type: 'scholar' }
                ]
            },
            {
                title: "ä½ è¦ºå¾—AIæœ€å¸å¼•ä½ çš„åœ°æ–¹æ˜¯ï¼Ÿ",
                options: [
                    { label: "ğŸŒŸ ç„¡é™çš„å¯èƒ½æ€§", desc: "AIæŠ€è¡“çš„ç™¼å±•å‰æ™¯å’Œæœªä¾†æ½›åŠ›", type: 'pioneer' },
                    { label: "ğŸ¨ å‰µæ„çš„å»¶ä¼¸", desc: "èƒ½å¹«åŠ©å¯¦ç¾ä»¥å‰ç„¡æ³•åšåˆ°çš„å‰µæ„", type: 'creator' },
                    { label: "âš¡ æ•ˆç‡çš„æå‡", desc: "å¤§å¹…æé«˜å·¥ä½œå’Œç”Ÿæ´»æ•ˆç‡", type: 'efficiency' },
                    { label: "ğŸ§  æ™ºèƒ½çš„å¥§ç§˜", desc: "AIèƒŒå¾Œçš„æŠ€è¡“åŸç†å’Œé‹ä½œæ–¹å¼", type: 'scholar' }
                ]
            },
            {
                title: "åœ¨AIå­¸ç¿’è·¯ä¸Šï¼Œä½ æœ€é‡è¦–ï¼Ÿ",
                options: [
                    { label: "ğŸš€ ç·Šè·Ÿæœ€æ–°è¶¨å‹¢", desc: "ç¸½æ˜¯é—œæ³¨æœ€æ–°çš„AIç™¼å±•å‹•æ…‹", type: 'pioneer' },
                    { label: "ğŸª æ¿€ç™¼å‰µæ„éˆæ„Ÿ", desc: "å­¸ç¿’å¦‚ä½•ç”¨AIæ¿€ç™¼æ›´å¤šå‰µæ„", type: 'creator' },
                    { label: "ğŸ“Š æŒæ¡å¯¦ç”¨æŠ€èƒ½", desc: "å­¸ç¿’èƒ½ç›´æ¥æ‡‰ç”¨çš„å¯¦ç”¨æŠ€å·§", type: 'efficiency' },
                    { label: "ğŸ“š å»ºç«‹çŸ¥è­˜é«”ç³»", desc: "ç³»çµ±åŒ–åœ°å­¸ç¿’AIç›¸é—œçŸ¥è­˜", type: 'scholar' }
                ]
            },
            {
                title: "ä½ å¸Œæœ›AIåœ¨ä½ ç”Ÿæ´»ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²ï¼Ÿ",
                options: [
                    { label: "ğŸ§­ æ¢éšªå¤¥ä¼´", desc: "ä¸€èµ·æ¢ç´¢æœªçŸ¥çš„æŠ€è¡“å‰æ²¿", type: 'pioneer' },
                    { label: "ğŸ¨ å‰µä½œæ­æª”", desc: "å”åŠ©å¯¦ç¾å„ç¨®å‰µæ„æƒ³æ³•", type: 'creator' },
                    { label: "âš™ï¸ æ•ˆç‡å·¥å…·", desc: "å¹«åŠ©è™•ç†å„ç¨®æ—¥å¸¸ä»»å‹™", type: 'efficiency' },
                    { label: "ğŸ“– æ™ºæ…§å°å¸«", desc: "æä¾›çŸ¥è­˜å’Œæ·±å…¥çš„è¦‹è§£", type: 'scholar' }
                ]
            },
            {
                title: "å°æ–¼AIçš„æœªä¾†ç™¼å±•ï¼Œä½ æœ€æœŸå¾…ï¼Ÿ",
                options: [
                    { label: "ğŸŒ æ”¹è®Šä¸–ç•Œçš„çªç ´", desc: "æœŸå¾…AIå¸¶ä¾†é©å‘½æ€§çš„è®ŠåŒ–", type: 'pioneer' },
                    { label: "ğŸ­ æ›´è±å¯Œçš„å‰µä½œå¯èƒ½", desc: "å¸Œæœ›AIèƒ½æ”¯æ´æ›´å¤šå‰µæ„è¡¨é”", type: 'creator' },
                    { label: "ğŸ”§ æ›´å¯¦ç”¨çš„åŠŸèƒ½", desc: "æœŸå¾…æ›´é«˜æ•ˆä¾¿åˆ©çš„AIå·¥å…·", type: 'efficiency' },
                    { label: "ğŸ§  æ›´æ·±å±¤çš„æ™ºèƒ½", desc: "å¸Œæœ›AIèƒ½é”åˆ°æ›´é«˜çš„æ™ºèƒ½æ°´æº–", type: 'scholar' }
                ]
            }
        ];

        // ===============================
        // Firebase å’Œé€£æ¥ç®¡ç†
        // ===============================

        async function initializeFirebase() {
            updateConnectionStatus('connecting');
            
            try {
                // æª¢æŸ¥Firebaseé…ç½®æ˜¯å¦å®Œæ•´
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "APIé ˆæ›´æ–°") {
                    throw new Error('Firebaseé…ç½®æœªå®Œæˆ');
                }

                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // æ¸¬è©¦é€£æ¥
                await testFirebaseConnection();
                
                firebaseInitialized = true;
                updateConnectionStatus('online');
                console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
                setupRealTimeStats();
                
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                firebaseInitialized = false;
                
                // é¡¯ç¤ºéŒ¯èª¤å°è©±æ¡†ï¼Œè®“ç”¨æˆ¶é¸æ“‡
                showConnectionErrorDialog(error.message);
            }
        }

        async function testFirebaseConnection() {
            // å˜—è©¦è®€å–ä¸€å€‹ç°¡å–®çš„æ–‡æª”ä¾†æ¸¬è©¦é€£æ¥
            const testRef = db.collection('test').doc('connection');
            await testRef.get();
        }

        function updateConnectionStatus(status) {
            connectionMode = status;
            const statusElement = document.getElementById('connectionStatus');
            
            switch (status) {
                case 'connecting':
                    statusElement.textContent = 'ğŸ”„ é€£æ¥ä¸­...';
                    statusElement.className = 'connection-status connecting';
                    break;
                case 'online':
                    statusElement.textContent = 'ğŸŸ¢ ç·šä¸Šæ¨¡å¼';
                    statusElement.className = 'connection-status online';
                    break;
                case 'offline':
                    statusElement.textContent = 'ğŸ”´ é›¢ç·šæ¨¡å¼';
                    statusElement.className = 'connection-status offline';
                    break;
                case 'demo':
                    statusElement.textContent = 'ğŸŸ¡ æ¼”ç¤ºæ¨¡å¼';
                    statusElement.className = 'connection-status demo';
                    break;
            }
        }

        function showConnectionErrorDialog(errorMessage) {
            const dialog = document.createElement('div');
            dialog.className = 'error-dialog';
            dialog.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">é€£æ¥å¤±æ•—</div>
                    <div class="error-message">
                        ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«æœå‹™å™¨ã€‚<br>
                        <small style="color: #999;">éŒ¯èª¤è©³æƒ…: ${errorMessage}</small><br><br>
                        æ˜¯å¦è¦ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ç¹¼çºŒï¼Ÿ<br>
                        <small style="color: #666;">æ¼”ç¤ºæ¨¡å¼å°‡é¡¯ç¤ºæ¨¡æ“¬æ•¸æ“šï¼Œä¸æœƒä¿å­˜æ‚¨çš„æ¸¬é©—çµæœã€‚</small>
                    </div>
                    <div class="error-buttons">
                        <button class="btn-confirm" onclick="useDemoMode()">æ˜¯ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</button>
                        <button class="btn-cancel" onclick="useOfflineMode()">å¦ï¼Œé¡¯ç¤ºé›¢ç·šç‹€æ…‹</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function useDemoMode() {
            document.querySelector('.error-dialog')?.remove();
            updateConnectionStatus('demo');
            simulateStats();
        }

        function useOfflineMode() {
            document.querySelector('.error-dialog')?.remove();
            updateConnectionStatus('offline');
            showOfflineStats();
        }

        function showOfflineStats() {
            updateStatsUI({
                total_users: 0,
                most_common: 'ç„¡æ•¸æ“š',
                rarest: 'ç„¡æ•¸æ“š',
                online_now: 0
            });
        }

        // ===============================
        // çµ±è¨ˆæ•¸æ“šç®¡ç†
        // ===============================

        function simulateStats() {
            const mockStats = {
                total_users: 15847,
                most_common: 'AIæ•ˆç‡ç‹',
                rarest: 'AIå­¸è€…',
                online_now: 2341
            };
            updateStatsUI(mockStats);
            
            // æ¨¡æ“¬å³æ™‚æ›´æ–°
            setInterval(() => {
                mockStats.total_users += Math.floor(Math.random() * 3);
                mockStats.online_now = Math.floor(mockStats.total_users * (0.1 + Math.random() * 0.2));
                updateStatsUI(mockStats);
            }, 10000);
        }

        function updateStatsUI(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users?.toLocaleString() || '0';
            document.getElementById('mostCommon').textContent = stats.most_common || 'ç„¡æ•¸æ“š';
            document.getElementById('rarest').textContent = stats.rarest || 'ç„¡æ•¸æ“š';
            document.getElementById('onlineNow').textContent = stats.online_now?.toLocaleString() || '0';
        }

        async function setupRealTimeStats() {
            if (!firebaseInitialized) return;
            
            try {
                db.collection('personality_stats').doc('global')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const stats = doc.data();
                            const distribution = stats.personality_distribution || {};
                            
                            // è¨ˆç®—æœ€å¸¸è¦‹å’Œæœ€ç¨€æœ‰çš„äººæ ¼é¡å‹
                            const sortedTypes = Object.entries(distribution)
                                .sort((a, b) => b[1] - a[1]);
                            
                            const mostCommon = sortedTypes[0] ? personalityTypes[sortedTypes[0][0]]?.name : 'AIæ•ˆç‡ç‹';
                            const rarest = sortedTypes[sortedTypes.length - 1] ? personalityTypes[sortedTypes[sortedTypes.length - 1][0]]?.name : 'AIå­¸è€…';
                            
                            updateStatsUI({
                                total_users: stats.total_users,
                                most_common: mostCommon,
                                rarest: rarest,
                                online_now: Math.floor(stats.total_users * 0.15)
                            });
                        }
                    }, (error) => {
                        console.error('å³æ™‚çµ±è¨ˆæ›´æ–°å¤±æ•—:', error);
                        // é™ç´šåˆ°æ¨¡æ“¬æ¨¡å¼
                        updateConnectionStatus('demo');
                        simulateStats();
                    });
            } catch (error) {
                console.error('è¨­ç½®å³æ™‚çµ±è¨ˆå¤±æ•—:', error);
                updateConnectionStatus('demo');
                simulateStats();
            }
        }

        // ===============================
        // æ¸¬é©—æµç¨‹ï¼ˆæ”¹é€²é¸æ“‡å‹•ç•«ï¼‰
        // ===============================

        function startTest() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è«‹å¡«å¯«æš±ç¨±æ‰èƒ½é–‹å§‹æ¸¬é©—ï¼');
                document.getElementById('username').focus();
                return;
            }

            currentQuestion = 0;
            answers = {};
            startTime = Date.now();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                calculatePersonality();
                return;
            }

            const question = questions[currentQuestion];
            const container = document.getElementById('questionContainer');
            
            // æ·»åŠ åˆ‡æ›å‹•ç•«
            container.classList.add('changing');
            
            setTimeout(() => {
                container.innerHTML = `
                    <div class="question-number">å•é¡Œ ${currentQuestion + 1}</div>
                    <h2 class="question-title">${question.title}</h2>
                    <div class="options-grid">
                        ${question.options.map((option, index) => `
                            <div class="option-card" onclick="selectOption('${option.type}', this)">
                                <div class="option-label">${option.label}</div>
                                <div class="option-description">${option.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.classList.remove('changing');
                updateProgress();
            }, 200);
        }

        function selectOption(type, element) {
            // é˜²æ­¢é‡è¤‡é»æ“Š
            if (element.classList.contains('selected') || element.classList.contains('loading')) {
                return;
            }

            answers[currentQuestion] = type;
            
            // ç«‹å³é¡¯ç¤ºé¸ä¸­ç‹€æ…‹å’Œloading
            const options = document.querySelectorAll('.option-card');
            options.forEach(option => {
                option.classList.remove('selected');
                option.style.pointerEvents = 'none'; // é˜²æ­¢å…¶ä»–é¸é …è¢«é»æ“Š
            });
            
            element.classList.add('selected', 'loading');
            
            // é¡¯ç¤ºä¸‹ä¸€é¡Œloadingæç¤º
            const loadingElement = document.getElementById('nextQuestionLoading');
            loadingElement.classList.add('show');
            
            // æ¸›å°‘å»¶é²æ™‚é–“ä¸¦åŠ ä¸Šå‹•ç•«
            setTimeout(() => {
                loadingElement.classList.remove('show');
                currentQuestion++;
                loadQuestion();
            }, 600); // å¾800msæ¸›å°‘åˆ°600ms
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `å•é¡Œ ${currentQuestion + 1} / ${questions.length}`;
        }

        async function calculatePersonality() {
            // è¨ˆç®—AIäººæ ¼é¡å‹
            const typeCounts = {};
            Object.values(answers).forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            // æ‰¾å‡ºæœ€å¤šçš„é¡å‹
            const dominantType = Object.keys(typeCounts).reduce((a, b) => 
                typeCounts[a] > typeCounts[b] ? a : b
            );

            const userData = {
                username: document.getElementById('username').value.trim(),
                location: document.getElementById('location').value || 'æœªçŸ¥',
                occupation: document.getElementById('occupation').value || 'æœªçŸ¥', 
                age_group: document.getElementById('ageGroup').value || 'æœªçŸ¥',
                personality_type: dominantType,
                type_scores: typeCounts,
                answers: answers
            };

            showLoading('æ­£åœ¨åˆ†æä½ çš„AIäººæ ¼ç‰¹è³ª...');
            
            const result = await submitPersonalityResult(userData);
            
            hideLoading();
            
            userResult = {
                ...userData,
                ...result
            };
            
            showPersonalityResult(dominantType, result);
        }

        async function showPersonalityResult(personalityType, result) {
            const personality = personalityTypes[personalityType];
            
            document.getElementById('testContainer').style.display = 'none';
            
            // è¨­å®šäººæ ¼å¾½ç« å’ŒåŸºæœ¬è³‡è¨Š
            document.getElementById('personalityBadge').textContent = personality.icon;
            document.getElementById('resultTitle').textContent = personality.name;
            document.getElementById('resultSubtitle').textContent = personality.subtitle;
            document.getElementById('resultDescription').textContent = personality.description;
            
            // è¨­å®šç‰¹è³ªæ˜Ÿç´š
            setTraitStars('innovation', personality.traits.innovation);
            setTraitStars('efficiency', personality.traits.efficiency);
            setTraitStars('creativity', personality.traits.creativity);
            setTraitStars('understanding', personality.traits.understanding);
            
            // å…ˆé¡¯ç¤ºè¼‰å…¥ä¸­çš„çµ±è¨ˆè³‡è¨Š
            document.getElementById('sameTypeCount').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('personalityPercent').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('personalityRarity').textContent = 'è¼‰å…¥ä¸­...';
            
            document.getElementById('resultContainer').classList.add('show');
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
            
            createCelebration();
            
            // ç•°æ­¥è¼‰å…¥çœŸå¯¦çµ±è¨ˆè³‡è¨Š
            await displayResultStats(personalityType, result);
        }

        async function displayResultStats(personalityType, result) {
            // å˜—è©¦ç²å–çœŸå¯¦çš„åˆ†ä½ˆæ•¸æ“š
            let realStats = null;
            let typePercentage, sameTypeCount, rarity, dataSource;
            
            if (firebaseInitialized && connectionMode === 'online') {
                try {
                    realStats = await getRealPersonalityDistribution();
                    console.log('ç²å–åˆ°çœŸå¯¦çµ±è¨ˆæ•¸æ“š:', realStats); // Debugç”¨
                } catch (error) {
                    console.error('ç²å–çœŸå¯¦çµ±è¨ˆå¤±æ•—:', error);
                }
            }
            
            if (realStats && realStats.totalUsers > 0) {
                // ä½¿ç”¨çœŸå¯¦æ•¸æ“š
                const typeCount = realStats.distribution[personalityType] || 0;
                typePercentage = realStats.totalUsers > 0 ? Math.round((typeCount / realStats.totalUsers) * 100) : 0;
                sameTypeCount = typeCount;
                rarity = getRarityLevel(typePercentage);
                dataSource = 'real';
                
                console.log(`çœŸå¯¦æ•¸æ“š - ${personalityType}: ${typeCount}äºº (${typePercentage}%)`); // Debugç”¨
            } else {
                // ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
                typePercentage = getPersonalityPercentage(personalityType);
                sameTypeCount = Math.floor((result.totalUsers || 15847) * typePercentage / 100);
                rarity = getRarityLevel(typePercentage);
                dataSource = 'simulated';
                
                console.log(`æ¨¡æ“¬æ•¸æ“š - ${personalityType}: ${sameTypeCount}äºº (${typePercentage}%)`); // Debugç”¨
            }
            
            // æ·»åŠ è¼‰å…¥å‹•ç•«
            const elements = ['sameTypeCount', 'personalityPercent', 'personalityRarity'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                element.style.opacity = '0.6';
                element.style.transform = 'scale(0.9)';
            });
            
            setTimeout(() => {
                document.getElementById('sameTypeCount').textContent = sameTypeCount.toLocaleString();
                document.getElementById('personalityPercent').textContent = `${typePercentage}%`;
                document.getElementById('personalityRarity').textContent = rarity;
                
                // æ¢å¾©å‹•ç•«
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    element.style.opacity = '1';
                    element.style.transform = 'scale(1)';
                    element.style.transition = 'all 0.3s ease';
                });
                
                // é¡¯ç¤ºæ•¸æ“šä¾†æºæ¨™ç¤º
                updateDataSourceLabel(dataSource, realStats?.totalUsers || 0);
            }, 500);
        }
        
        function updateDataSourceLabel(dataSource, totalUsers = 0) {
            const statsContainer = document.querySelector('.global-stats');
            const existingLabel = statsContainer.querySelector('.data-source-label');
            if (existingLabel) existingLabel.remove();
            
            const dataLabel = document.createElement('div');
            dataLabel.className = 'data-source-label';
            dataLabel.style.cssText = `
                text-align: center;
                margin-top: 15px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 10px;
                font-size: 12px;
                color: #666;
                border: 1px solid rgba(102, 126, 234, 0.2);
            `;
            
            if (dataSource === 'real') {
                dataLabel.innerHTML = `
                    <strong>ğŸ“Š çœŸå¯¦æ•¸æ“šçµ±è¨ˆ</strong><br>
                    <span style="color: #888; font-size: 11px;">åŸºæ–¼ ${totalUsers.toLocaleString()} ä½çœŸå¯¦ç”¨æˆ¶çš„æ¸¬é©—çµæœ</span>
                `;
            } else {
                dataLabel.innerHTML = `
                    <strong>ğŸ¯ æ¼”ç¤ºæ•¸æ“š</strong><br>
                    <span style="color: #888; font-size: 11px;">åŸºæ–¼æ¨¡æ“¬çµ±è¨ˆï¼Œåƒ…ä¾›åƒè€ƒ</span>
                `;
            }
            
            statsContainer.appendChild(dataLabel);
        }

        async function getRealPersonalityDistribution() {
            if (!firebaseInitialized || connectionMode !== 'online') {
                throw new Error('Firebaseæœªåˆå§‹åŒ–æˆ–éç·šä¸Šæ¨¡å¼');
            }
            
            const doc = await db.collection('personality_stats').doc('global').get();
            
            if (!doc.exists) {
                throw new Error('çµ±è¨ˆæ–‡æª”ä¸å­˜åœ¨');
            }
            
            const data = doc.data();
            return {
                totalUsers: data.total_users || 0,
                distribution: data.personality_distribution || {}
            };
        }

        function getRarityLevel(percentage) {
            if (percentage >= 30) return 'å¸¸è¦‹';
            if (percentage >= 20) return 'æ™®é€š';
            if (percentage >= 15) return 'å°‘è¦‹';
            return 'ç¨€æœ‰';
        }

        function setTraitStars(traitId, level) {
            const container = document.getElementById(`${traitId}-stars`);
            container.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = i <= level ? 'star' : 'star empty';
                star.textContent = 'â˜…';
                container.appendChild(star);
            }
        }

        function getPersonalityPercentage(type) {
            // æ¨¡æ“¬æ•¸æ“šçš„å›ºå®šç™¾åˆ†æ¯”
            const percentages = {
                pioneer: 23,
                creator: 28,
                efficiency: 31,
                scholar: 18
            };
            return percentages[type] || 25;
        }

        // ===============================
        // è³‡æ–™åº«æ“ä½œ
        // ===============================

        async function submitPersonalityResult(userData) {
            // å¦‚æœæ˜¯é›¢ç·šæ¨¡å¼ï¼Œä¸ä¿å­˜æ•¸æ“š
            if (connectionMode === 'offline') {
                return {
                    success: false,
                    totalUsers: 0,
                    userId: 'offline_mode',
                    message: 'é›¢ç·šæ¨¡å¼ï¼Œæ•¸æ“šæœªä¿å­˜'
                };
            }
            
            // å¦‚æœä¸æ˜¯ç·šä¸Šæ¨¡å¼ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
            if (!firebaseInitialized || connectionMode !== 'online') {
                return {
                    success: true,
                    totalUsers: 15847,
                    userId: 'demo_' + Date.now(),
                    message: 'æ¼”ç¤ºæ¨¡å¼'
                };
            }

            try {
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const testData = {
                    ...userData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ip_hash: await hashIP(await getUserIP()),
                    user_agent: navigator.userAgent,
                    test_duration: Math.floor((Date.now() - startTime) / 1000)
                };
                
                await db.collection('personality_rankings').doc(userId).set(testData);
                const totalUsers = await updateGlobalStatsInDB(testData);
                
                return { success: true, totalUsers: totalUsers, userId: userId };
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                
                // é™ç´šåˆ°æ¼”ç¤ºæ¨¡å¼
                updateConnectionStatus('demo');
                
                return { 
                    success: false, 
                    error: error.message,
                    totalUsers: 15847,
                    userId: 'error_' + Date.now()
                };
            }
        }

        async function updateGlobalStatsInDB(userData) {
            if (!firebaseInitialized || connectionMode !== 'online') return 15847;
            
            try {
                const statsRef = db.collection('personality_stats').doc('global');
                let totalUsers = 15847;
                
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(statsRef);
                    
                    if (!doc.exists) {
                        transaction.set(statsRef, {
                            total_users: 1,
                            personality_distribution: {
                                [userData.personality_type]: 1
                            },
                            last_updated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        totalUsers = 1;
                    } else {
                        const currentStats = doc.data();
                        totalUsers = (currentStats.total_users || 0) + 1;
                        transaction.update(statsRef, {
                            total_users: firebase.firestore.FieldValue.increment(1),
                            [`personality_distribution.${userData.personality_type}`]: firebase.firestore.FieldValue.increment(1),
                            last_updated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                return totalUsers;
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
                return 15847;
            }
        }

        // ===============================
        // äººæ ¼åˆ†ä½ˆçµ±è¨ˆåŠŸèƒ½ï¼ˆå–ä»£åŸæœ¬çš„æ’è¡Œæ¦œï¼‰
        // ===============================

        async function showPersonalityStats() {
            if (pendingStatsRequest) return;
            pendingStatsRequest = true;
            
            document.getElementById('personalityStatsSection').style.display = 'block';
            document.getElementById('personalityStatsSection').scrollIntoView({ behavior: 'smooth' });
            
            const content = document.getElementById('personalityStatsContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥çµ±è¨ˆæ•¸æ“šä¸­...</p>
                </div>
            `;
            
            try {
                let statsData;
                
                if (firebaseInitialized && connectionMode === 'online') {
                    // å˜—è©¦å¾Firebaseè¼‰å…¥çœŸå¯¦æ•¸æ“š
                    statsData = await loadRealPersonalityStats();
                } else if (connectionMode === 'demo') {
                    // ä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
                    await new Promise(resolve => setTimeout(resolve, 1500)); // æ¨¡æ“¬è¼‰å…¥æ™‚é–“
                    statsData = generateMockPersonalityStats();
                } else {
                    // é›¢ç·šæ¨¡å¼
                    throw new Error('é›¢ç·šæ¨¡å¼ç„¡æ³•è¼‰å…¥çµ±è¨ˆæ•¸æ“š');
                }
                
                displayPersonalityStats(statsData);
                
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
                showStatsError(error.message);
            } finally {
                pendingStatsRequest = false;
            }
        }

        async function loadRealPersonalityStats() {
            try {
                const doc = await db.collection('personality_stats').doc('global').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const distribution = data.personality_distribution || {};
                    const totalUsers = data.total_users || 0;
                    
                    // è½‰æ›æ•¸æ“šæ ¼å¼
                    const stats = Object.entries(personalityTypes).map(([key, personality]) => {
                        const count = distribution[key] || 0;
                        const percentage = totalUsers > 0 ? Math.round((count / totalUsers) * 100) : 0;
                        
                        return {
                            type: key,
                            ...personality,
                            count: count,
                            percentage: percentage
                        };
                    });
                    
                    // æŒ‰äººæ•¸æ’åº
                    stats.sort((a, b) => b.count - a.count);
                    
                    return {
                        totalUsers: totalUsers,
                        personalities: stats
                    };
                } else {
                    throw new Error('ç„¡çµ±è¨ˆæ•¸æ“š');
                }
            } catch (error) {
                console.error('è®€å–çœŸå¯¦çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
                throw error;
            }
        }

        function generateMockPersonalityStats() {
            const mockDistribution = {
                efficiency: 4850,  // 31%
                creator: 4380,     // 28%
                pioneer: 3600,     // 23%
                scholar: 2817      // 18%
            };
            
            const totalUsers = Object.values(mockDistribution).reduce((a, b) => a + b, 0);
            
            const stats = Object.entries(personalityTypes).map(([key, personality]) => {
                const count = mockDistribution[key] || 0;
                const percentage = Math.round((count / totalUsers) * 100);
                
                return {
                    type: key,
                    ...personality,
                    count: count,
                    percentage: percentage
                };
            });
            
            // æŒ‰äººæ•¸æ’åº
            stats.sort((a, b) => b.count - a.count);
            
            return {
                totalUsers: totalUsers,
                personalities: stats
            };
        }

        function displayPersonalityStats(statsData) {
            const content = document.getElementById('personalityStatsContent');
            
            if (!statsData || !statsData.personalities || statsData.personalities.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                        <h3 style="color: #666; margin-bottom: 15px;">æš«ç„¡çµ±è¨ˆæ•¸æ“š</h3>
                        <p style="color: #999;">æˆç‚ºç¬¬ä¸€å€‹å®Œæˆæ¸¬é©—çš„äººå§ï¼</p>
                    </div>
                `;
                return;
            }
            
            const maxPercentage = Math.max(...statsData.personalities.map(p => p.percentage));
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <p style="color: #666; font-size: 16px;">
                        åŸºæ–¼ <strong>${statsData.totalUsers.toLocaleString()}</strong> äººçš„æ¸¬é©—çµæœ
                    </p>
                </div>
                
                <div class="personality-distribution">
                    ${statsData.personalities.map((personality, index) => {
                        const barWidth = maxPercentage > 0 ? (personality.percentage / maxPercentage) * 100 : 0;
                        const isUserType = userResult && userResult.personality_type === personality.type;
                        
                        return `
                            <div class="personality-stat-item" style="${isUserType ? 'background: linear-gradient(135deg, #e3f2fd, #f0f8ff); border: 2px solid #2196f3;' : ''}">
                                <div class="personality-stat-icon">${personality.icon}</div>
                                <div class="personality-stat-info">
                                    <div class="personality-stat-name">
                                        ${personality.name} ${isUserType ? '(ä½ çš„é¡å‹)' : ''}
                                    </div>
                                    <div class="personality-stat-subtitle">${personality.subtitle}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                        ${personality.count.toLocaleString()} äºº
                                    </div>
                                </div>
                                <div class="personality-stat-bar">
                                    <div class="personality-stat-fill" style="width: ${barWidth}%"></div>
                                </div>
                                <div class="personality-stat-percent">${personality.percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                    <p style="color: #666; font-size: 14px;">
                        âœ¨ <strong>æ¯ç¨®AIäººæ ¼éƒ½æœ‰å…¶ç¨ç‰¹åƒ¹å€¼ï¼</strong><br>
                        é€™äº›çµ±è¨ˆæ•¸æ“šåæ˜ äº†ä¸åŒçš„AIä½¿ç”¨é¢¨æ ¼å’Œåå¥½ï¼Œ<br>
                        æ²’æœ‰å„ªåŠ£ä¹‹åˆ†ï¼Œåªæœ‰ä¸åŒçš„ç‰¹è‰²å’Œå„ªå‹¢ã€‚
                    </p>
                </div>
            `;
            
            // å‹•ç•«æ•ˆæœ
            setTimeout(() => {
                const fills = document.querySelectorAll('.personality-stat-fill');
                fills.forEach(fill => {
                    const width = fill.style.width;
                    fill.style.width = '0%';
                    setTimeout(() => {
                        fill.style.width = width;
                    }, 100);
                });
            }, 200);
        }

        function showStatsError(errorMessage) {
            const content = document.getElementById('personalityStatsContent');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">è¼‰å…¥å¤±æ•—</h3>
                    <p style="color: #666; margin-bottom: 20px;">ç„¡æ³•è¼‰å…¥çµ±è¨ˆæ•¸æ“š</p>
                    <small style="color: #999;">éŒ¯èª¤è©³æƒ…: ${errorMessage}</small>
                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="showStatsFallbackDialog()" style="font-size: 14px; padding: 12px 24px;">
                            é¡¯ç¤ºæ¼”ç¤ºæ•¸æ“š
                        </button>
                    </div>
                </div>
            `;
        }

        function showStatsFallbackDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'error-dialog';
            dialog.innerHTML = `
                <div class="error-content">
                    <div class="error-icon">ğŸ“Š</div>
                    <div class="error-title">çµ±è¨ˆæ•¸æ“šè¼‰å…¥å¤±æ•—</div>
                    <div class="error-message">
                        ç„¡æ³•å¾æœå‹™å™¨è¼‰å…¥çµ±è¨ˆæ•¸æ“šã€‚<br><br>
                        æ˜¯å¦è¦é¡¯ç¤ºæ¼”ç¤ºçµ±è¨ˆæ•¸æ“šï¼Ÿ<br>
                        <small style="color: #666;">æ¼”ç¤ºæ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œä¸ä»£è¡¨çœŸå¯¦çµ±è¨ˆã€‚</small>
                    </div>
                    <div class="error-buttons">
                        <button class="btn-confirm" onclick="showDemoStats()">æ˜¯ï¼Œé¡¯ç¤ºæ¼”ç¤ºæ•¸æ“š</button>
                        <button class="btn-cancel" onclick="cancelStats()">å¦ï¼Œè¿”å›çµæœé é¢</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        function showDemoStats() {
            document.querySelector('.error-dialog')?.remove();
            const demoData = generateMockPersonalityStats();
            displayPersonalityStats(demoData);
        }

        function cancelStats() {
            document.querySelector('.error-dialog')?.remove();
            hidePersonalityStats();
        }

        function hidePersonalityStats() {
            document.getElementById('personalityStatsSection').style.display = 'none';
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // ===============================
        // è¼”åŠ©å‡½æ•¸
        // ===============================

        function shareResult() {
            if (!userResult) return;
            
            const personality = personalityTypes[userResult.personality_type];
            const percentage = getPersonalityPercentage(userResult.personality_type);
            const shareText = `æˆ‘å‰›å®Œæˆäº†AIäººæ ¼ç‰¹è³ªæ¸¬é©—ï¼

ğŸ¯ æˆ‘çš„AIäººæ ¼ï¼š${personality.name}
${personality.subtitle}
ğŸ¦… æˆ‘çš„AIå¤¥ä¼´ï¼š${personality.animal}
ğŸ“Š å…¨çƒä½”æ¯”ï¼š${percentage}%

ä½ çš„AIäººæ ¼æ˜¯ä»€éº¼ï¼Ÿå¿«ä¾†æ¸¬è©¦çœ‹çœ‹ï¼

ç”± Nick Chang | ZN Studio å‰µä½œ
Nick Changï½œnickleo051216@gmail.comï½œ0932-684-051
#AIäººæ ¼æ¸¬é©— #${personality.name} #äººå·¥æ™ºæ…§`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AIäººæ ¼ç‰¹è³ªæ¸¬é©—çµæœ',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    showNotification('çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼å¿«å»åˆ†äº«ä½ çš„AIäººæ ¼å§ ğŸ‰');
                });
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        async function hashIP(ip) {
            const encoder = new TextEncoder();
            const data = encoder.encode(ip + 'ai-personality-salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p style="color: #666; margin: 0;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function createCelebration() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.innerHTML = ['ğŸ‰', 'âœ¨', 'ğŸŠ', 'â­'][Math.floor(Math.random() * 4)];
                    confetti.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}vw;
                        top: -10px;
                        font-size: 20px;
                        z-index: 1000;
                        pointer-events: none;
                        animation: fall ${Math.random() * 3 + 2}s linear forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 100);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
                animation: slideInRight 0.5s ease forwards;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // ===============================
        // åˆå§‹åŒ–
        // ===============================

        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        // æ·»åŠ å‹•ç•«CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // é˜²æ­¢æ¸¬é©—é€²è¡Œä¸­é›¢é–‹é é¢
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                e.preventDefault();
                e.returnValue = 'ä½ çš„æ¸¬é©—é€²åº¦å°‡æœƒéºå¤±ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });

        // å…¨åŸŸå‡½æ•¸ï¼ˆä¾›HTML onclickèª¿ç”¨ï¼‰
        window.startTest = startTest;
        window.selectOption = selectOption;
        window.shareResult = shareResult;
        window.showPersonalityStats = showPersonalityStats;
        window.hidePersonalityStats = hidePersonalityStats;
        window.useDemoMode = useDemoMode;
        window.useOfflineMode = useOfflineMode;
        window.showDemoStats = showDemoStats;
        window.cancelStats = cancelStats;
        window.showStatsFallbackDialog = showStatsFallbackDialog;
    </script>
</body>
</html>
