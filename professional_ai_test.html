<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI世代能力測驗 - 發現你的全球排名</title>
    <meta name="description" content="全球首創AI能力分級測驗，即時更新全球排名系統">
    <meta property="og:title" content="AI世代能力測驗 - 你的AI段位是什麼？">
    <meta property="og:description" content="5分鐘測出你的AI能力段位，加入全球即時排名！">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/667eea/ffffff?text=AI%E4%B8%96%E4%BB%A3%E8%83%BD%E5%8A%9B%E6%B8%AC%E9%A9%97">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .hero-section {
            text-align: center;
            padding: 60px 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 200% 100%;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .hero-title {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .creator-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .creator-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .test-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            position: relative;
            overflow: hidden;
        }

        .user-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-container {
            margin-bottom: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .question-container {
            opacity: 0;
            transform: translateX(50px);
            animation: slideIn 0.6s ease forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-number {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .question-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.3;
        }

        .options-grid {
            display: grid;
            gap: 15px;
            margin: 30px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e8ecf4;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.02);
        }

        .option-label {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .option-description {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .result-container.show {
            display: block;
            animation: resultAppear 0.8s ease forwards;
        }

        @keyframes resultAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result-badge {
            display: inline-block;
            font-size: 64px;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
        }

        .result-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-description {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .result-stat {
            background: rgba(102, 126, 234, 0.1);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .result-stat-number {
            font-size: 28px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }

        .result-stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 15px 40px rgba(240, 147, 251, 0.4);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leaderboard-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 40px 0;
            display: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin: 10px 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .rank-number {
            font-size: 24px;
            font-weight: 800;
            color: #667eea;
            min-width: 50px;
            text-align: center;
        }

        .user-info {
            flex-grow: 1;
            margin-left: 20px;
        }

        .username {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .user-details {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .user-score {
            font-size: 20px;
            font-weight: 700;
            color: #27ae60;
        }

        .medal {
            font-size: 32px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 36px;
            }
            
            .test-container, .result-container {
                padding: 30px 20px;
                margin: 20px 0;
                border-radius: 20px;
            }
            
            .question-title {
                font-size: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .result-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題區域 -->
        <div class="hero-section">
            <h1 class="hero-title">🤖 AI世代能力測驗</h1>
            <p class="hero-subtitle">全球首創AI能力分級系統 - 即時排名</p>
            <p style="color: #888; margin-bottom: 30px;">
                在AI快速發展的時代，發現你的真實AI段位，加入全球即時排名！
            </p>
            <a href="https://portaly.cc/zn.studio" target="_blank" class="creator-badge">
                <span style="margin-right: 8px;">🚀</span>
                由 Nick Chang | ZN Studio 創作
            </a>
        </div>

        <!-- 即時統計 -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">載入中...</div>
                <div class="stat-label">全球參與人數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageScore">--</div>
                <div class="stat-label">平均分數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="topScore">--</div>
                <div class="stat-label">最高分數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineNow">--</div>
                <div class="stat-label">目前在線</div>
            </div>
        </div>

        <!-- 測驗區域 -->
        <div class="test-container" id="testContainer">
            <!-- 用戶資料表單 -->
            <div class="user-form">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                    📝 請填寫基本資料以加入全球排名
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">暱稱 *</label>
                        <input type="text" id="username" placeholder="請輸入你的暱稱" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="location">地區</label>
                        <select id="location">
                            <option value="">選擇地區（可選）</option>
                            <option value="台北">台北</option>
                            <option value="新北">新北</option>
                            <option value="桃園">桃園</option>
                            <option value="台中">台中</option>
                            <option value="台南">台南</option>
                            <option value="高雄">高雄</option>
                            <option value="其他台灣地區">其他台灣地區</option>
                            <option value="香港">香港</option>
                            <option value="新加坡">新加坡</option>
                            <option value="馬來西亞">馬來西亞</option>
                            <option value="中國大陸">中國大陸</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="occupation">職業</label>
                        <select id="occupation">
                            <option value="">選擇職業（可選）</option>
                            <option value="學生">學生</option>
                            <option value="工程師">工程師</option>
                            <option value="設計師">設計師</option>
                            <option value="行銷人員">行銷人員</option>
                            <option value="創業者">創業者</option>
                            <option value="教師">教師</option>
                            <option value="醫護人員">醫護人員</option>
                            <option value="金融業">金融業</option>
                            <option value="服務業">服務業</option>
                            <option value="自由工作者">自由工作者</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ageGroup">年齡層</label>
                        <select id="ageGroup">
                            <option value="">選擇年齡層（可選）</option>
                            <option value="18-24">18-24歲</option>
                            <option value="25-34">25-34歲</option>
                            <option value="35-44">35-44歲</option>
                            <option value="45-54">45-54歲</option>
                            <option value="55+">55歲以上</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">準備開始測驗</div>
            </div>

            <div class="question-container" id="questionContainer">
                <div style="text-align: center; padding: 40px;">
                    <button class="btn" onclick="startTest()" style="font-size: 18px; padding: 20px 50px;">
                        🚀 開始測驗
                    </button>
                </div>
            </div>
        </div>

        <!-- 結果區域 -->
        <div class="result-container" id="resultContainer">
            <div class="result-badge" id="resultBadge">🏆</div>
            <h2 class="result-title" id="resultTitle">測驗完成</h2>
            <p class="result-description" id="resultDescription">結果描述</p>

            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-number" id="userScore">--</div>
                    <div class="result-stat-label">你的分數</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-number" id="userRank">--</div>
                    <div class="result-stat-label">全球排名</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-number" id="userPercentile">--</div>
                    <div class="result-stat-label">超越用戶</div>
                </div>
            </div>

            <div style="margin: 40px 0;">
                <button class="btn" onclick="shareResult()">
                    📤 分享我的AI段位
                </button>
                <button class="btn btn-secondary" onclick="showLeaderboard()">
                    🏆 查看全球排行榜
                </button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 15px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    <strong>想提升你的AI能力？</strong>
                </p>
                <p style="color: #888; font-size: 12px; margin-bottom: 15px;">
                    加入Nick Chang的Line社群，獲得最新AI學習資源！
                </p>
                <a href="https://reurl.cc/1OZNAY" target="_blank" class="btn" style="font-size: 14px; padding: 12px 24px;">
                    🎯 加入AI學習社群
                </a>
            </div>
        </div>

        <!-- 排行榜區域 -->
        <div class="leaderboard-section" id="leaderboardSection">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">🏆 全球排行榜</h2>
            <div id="leaderboardContent">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>載入排行榜中...</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="hideLeaderboard()">返回結果</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // Firebase 設定區域
        // ===============================
        
        // 🔥 重要：請替換為你的 Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAqwdMVnhrj0Ktj9BTEOVJdpzBLPpMaTq",
            authDomain: "ai-level-test.firebaseapp.com", 
            projectId: "ai-level-test",
            storageBucket: "ai-level-test.firebasestorage.app",
            messagingSenderId: "774029966921",
            appId: "1:774029966921:web:5bceaeb011e665f4ccc40c",
            measurementId: "G-TH0M0VXRZC"
        };

        // 初始化 Firebase（如果配置完整的話）
        let db = null;
        let firebaseInitialized = false;

        function initializeFirebase() {
            try {
                if (firebaseConfig.apiKey !== "API須更新") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase 初始化成功');
                    
                    // 設定即時監聽
                    setupRealTimeStats();
                } else {
                    console.log('Firebase 配置未完成，使用模擬模式');
                    simulateStats();
                }
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                simulateStats();
            }
        }

        // ===============================
        // 全域變數
        // ===============================
        
        let currentQuestion = 0;
        let answers = {};
        let startTime = Date.now();
        let userResult = null;

        // 問題庫
        const questions = [
            {
                title: "你多久使用一次 AI 工具？",
                options: [
                    { label: "🔍 AI新手", desc: "從來沒用過，但聽說過 ChatGPT", value: 1 },
                    { label: "🌱 偶爾嘗試", desc: "每月用 1-2 次，主要是好奇", value: 2 },
                    { label: "⚡ 定期使用者", desc: "每週使用幾次，開始習慣", value: 3 },
                    { label: "🚀 重度依賴", desc: "幾乎每天使用，工作生活都需要", value: 4 },
                    { label: "👑 AI大師", desc: "一天多次，已經無法想像沒有 AI 的生活", value: 5 }
                ]
            },
            {
                title: "你主要用 AI 來做什麼？",
                options: [
                    { label: "🔍 基礎查詢", desc: "問簡單問題，就像使用 Google", value: 1 },
                    { label: "📝 內容創作", desc: "寫文章、翻譯、學習新知識", value: 2 },
                    { label: "💼 工作應用", desc: "處理文件、製作簡報、數據分析", value: 3 },
                    { label: "⚡ 專業開發", desc: "寫程式、創意設計、複雜專案", value: 4 },
                    { label: "🤖 系統整合", desc: "建立 AI 工作流程、訓練模型", value: 5 }
                ]
            },
            {
                title: "你對 AI 提示詞（Prompt）的掌握程度？", 
                options: [
                    { label: "❓ 完全不懂", desc: "不知道什麼是提示詞", value: 1 },
                    { label: "🗣️ 基礎對話", desc: "會問簡單問題", value: 2 },
                    { label: "📋 清楚指令", desc: "會寫清楚的指令和要求", value: 3 },
                    { label: "🎯 進階技巧", desc: "會用角色設定、範例等技巧", value: 4 },
                    { label: "🔬 專家級", desc: "精通複雜提示詞工程", value: 5 }
                ]
            },
            {
                title: "你使用過多少種不同的 AI 工具？",
                options: [
                    { label: "0️⃣ 只聽說過", desc: "只聽說過 ChatGPT", value: 1 },
                    { label: "1️⃣ 初學者", desc: "用過 1-2 種（ChatGPT、Gemini 等）", value: 2 },
                    { label: "3️⃣ 探索者", desc: "用過 3-5 種不同類型 AI 工具", value: 3 },
                    { label: "8️⃣ 實踐者", desc: "用過 5-10 種，包含專業工具", value: 4 },
                    { label: "🌟 收藏家", desc: "超過 10 種，涵蓋各領域 AI 工具", value: 5 }
                ]
            },
            {
                title: "AI 對你工作/學習效率的提升程度？",
                options: [
                    { label: "🚫 沒有影響", desc: "完全沒用過 AI 協助工作", value: 1 },
                    { label: "📖 偶爾查詢", desc: "偶爾用來查資料或翻譯", value: 2 },
                    { label: "⬆️ 小幅提升", desc: "提升了 20-30% 的工作效率", value: 3 },
                    { label: "🚀 重要助手", desc: "AI 已成為工作的重要助手", value: 4 },
                    { label: "💎 不可或缺", desc: "沒有 AI 就無法正常工作", value: 5 }
                ]
            }
        ];

        // ===============================
        // 資料庫操作函數
        // ===============================

        // 提交測驗結果
        async function submitTestResult(userData) {
            if (!firebaseInitialized) {
                // 模擬模式
                return {
                    success: true,
                    rank: Math.floor(Math.random() * 1000) + 100,
                    userId: 'demo_' + Date.now()
                };
            }

            try {
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const testData = {
                    ...userData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ip_hash: await hashIP(await getUserIP()),
                    user_agent: navigator.userAgent,
                    test_duration: Math.floor((Date.now() - startTime) / 1000)
                };
                
                await db.collection('rankings').doc(userId).set(testData);
                await updateGlobalStats(testData);
                
                const userRank = await calculateUserRank(testData.score);
                
                return { success: true, rank: userRank, userId: userId };
            } catch (error) {
                console.error('儲存失敗:', error);
                return { 
                    success: false, 
                    error: error.message,
                    rank: Math.floor(Math.random() * 1000) + 100
                };
            }
        }

        // 計算用戶排名
        async function calculateUserRank(userScore) {
            if (!firebaseInitialized) return Math.floor(Math.random() * 1000) + 100;
            
            try {
                const snapshot = await db.collection('rankings')
                    .where('score', '>', userScore)
                    .get();
                return snapshot.size + 1;
            } catch (error) {
                console.error('計算排名失敗:', error);
                return Math.floor(Math.random() * 1000) + 100;
            }
        }

        // 獲取排行榜
        async function getLeaderboard(limit = 20) {
            if (!firebaseInitialized) {
                // 模擬數據
                return generateMockLeaderboard();
            }
            
            try {
                const snapshot = await db.collection('rankings')
                    .orderBy('score', 'desc')
                    .orderBy('timestamp', 'asc')
                    .limit(limit)
                    .get();
                
                const leaderboard = [];
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    leaderboard.push({
                        rank: index + 1,
                        id: doc.id,
                        username: data.username,
                        location: data.location || '未知',
                        occupation: data.occupation || '未知',
                        score: data.score,
                        level: data.level,
                        timestamp: data.timestamp
                    });
                });
                
                return leaderboard;
            } catch (error) {
                console.error('獲取排行榜失敗:', error);
                return generateMockLeaderboard();
            }
        }

        // 設定即時統計監聽
        function setupRealTimeStats() {
            if (!firebaseInitialized) return;
            
            db.collection('stats').doc('global')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const stats = doc.data();
                        updateStatsUI(stats);
                    }
                });
        }

        // 更新全域統計
        async function updateGlobalStats(newUserData) {
            if (!firebaseInitialized) return;
            
            const globalStatsRef = db.collection('stats').doc('global');
            
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(globalStatsRef);
                
                if (!doc.exists) {
                    transaction.set(globalStatsRef, {
                        total_users: 1,
                        average_score: newUserData.score,
                        top_score: newUserData.score,
                        last_updated: firebase.firestore.FieldValue.serverTimestamp(),
                        level_distribution: {
                            [newUserData.level]: 1
                        }
                    });
                } else {
                    const currentStats = doc.data();
                    const newTotalUsers = currentStats.total_users + 1;
                    const newAverageScore = ((currentStats.average_score * currentStats.total_users) + newUserData.score) / newTotalUsers;
                    
                    transaction.update(globalStatsRef, {
                        total_users: newTotalUsers,
                        average_score: Math.round(newAverageScore * 10) / 10,
                        top_score: Math.max(currentStats.top_score, newUserData.score),
                        last_updated: firebase.firestore.FieldValue.serverTimestamp(),
                        [`level_distribution.${newUserData.level}`]: firebase.firestore.FieldValue.increment(1)
                    });
                }
            });
        }

        // ===============================
        // 輔助函數
        // ===============================

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        async function hashIP(ip) {
            const encoder = new TextEncoder();
            const data = encoder.encode(ip + 'ai-test-salt');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // 模擬統計數據
        function simulateStats() {
            const mockStats = {
                total_users: 12847 + Math.floor(Math.random() * 100),
                average_score: 18.3,
                top_score: 25,
                last_updated: new Date()
            };
            updateStatsUI(mockStats);
            
            // 定期更新模擬數據
            setInterval(() => {
                mockStats.total_users += Math.floor(Math.random() * 3);
                updateStatsUI(mockStats);
            }, 10000);
        }

        // 更新統計UI
        function updateStatsUI(stats) {
            document.getElementById('totalUsers').textContent = stats.total_users.toLocaleString();
            document.getElementById('averageScore').textContent = stats.average_score;
            document.getElementById('topScore').textContent = stats.top_score;
            
            const onlineEstimate = Math.floor(stats.total_users * (0.1 + Math.random() * 0.2));
            document.getElementById('onlineNow').textContent = onlineEstimate.toLocaleString();
        }

        // 生成模擬排行榜
        function generateMockLeaderboard() {
            const names = ['AI達人', '科技新星', '程式高手', '設計師小王', '創業家', '學習狂', '工程師A', '數據分析師', '產品經理', 'ChatGPT愛用者'];
            const locations = ['台北', '上海', '香港', '新加坡', '台中', '深圳', '高雄', '北京', '廣州', '東京'];
            const occupations = ['工程師', '設計師', '學生', '創業者', '行銷人員', '數據分析師', '產品經理', '自由工作者'];
            
            return Array.from({length: 20}, (_, i) => ({
                rank: i + 1,
                username: names[Math.floor(Math.random() * names.length)] + (Math.floor(Math.random() * 999) + 1),
                location: locations[Math.floor(Math.random() * locations.length)],
                occupation: occupations[Math.floor(Math.random() * occupations.length)],
                score: 25 - Math.floor(i / 2) - Math.floor(Math.random() * 3),
                level: i < 3 ? 'master' : i < 8 ? 'diamond' : i < 15 ? 'gold' : 'silver'
            }));
        }

        // ===============================
        // 測驗邏輯
        // ===============================

        function startTest() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('請填寫暱稱才能開始測驗！');
                document.getElementById('username').focus();
                return;
            }

            currentQuestion = 0;
            answers = {};
            startTime = Date.now();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                calculateResult();
                return;
            }

            const question = questions[currentQuestion];
            const container = document.getElementById('questionContainer');
            
            container.style.opacity = '0';
            setTimeout(() => {
                container.innerHTML = `
                    <div class="question-number">問題 ${currentQuestion + 1}</div>
                    <h2 class="question-title">${question.title}</h2>
                    <div class="options-grid">
                        ${question.options.map((option, index) => `
                            <div class="option-card" onclick="selectOption(${option.value})">
                                <div class="option-label">${option.label}</div>
                                <div class="option-description">${option.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.style.opacity = '1';
                updateProgress();
            }, 300);
        }

        function selectOption(value) {
            answers[currentQuestion] = value;
            
            // 視覺反饋
            const options = document.querySelectorAll('.option-card');
            options.forEach(option => option.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            setTimeout(() => {
                currentQuestion++;
                loadQuestion();
            }, 800);
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `問題 ${currentQuestion + 1} / ${questions.length}`;
        }

    // ... (calculateResult 函數的前半部分) ...

async function calculateResult() {
    const totalScore = Object.values(answers).reduce((sum, value) => sum + value, 0);
    const level = determineLevel(totalScore);
    
    const userData = {
        username: document.getElementById('username').value.trim(),
        location: document.getElementById('location').value || '未知',
        occupation: document.getElementById('occupation').value || '未知', 
        age_group: document.getElementById('ageGroup').value || '未知',
        score: totalScore,
        level: level,
        answers: answers
    };

    showLoading('正在儲存結果並計算全球排名...');
    
    // submitTestResult 已經幫我們拿到了 rank
    const submitResult = await submitTestResult(userData);
    
    hideLoading();
    
    // 這裡我們直接使用 submitTestResult 的結果
    if (submitResult.success) {
        userResult = {
            ...userData,
            rank: submitResult.rank,
            userId: submitResult.userId
        };

        // 現在來獲取總人數並計算百分位
        const { totalUsers, percentile } = await calculatePercentile(submitResult.rank);
        
        // 呼叫 showResult
        showResult(level, totalScore, submitResult.rank, percentile, totalUsers);

    } else {
        alert('提交結果失敗，請稍後再試。');
        // 可以考慮重新載入頁面或返回首頁
    }
}

// 新增這個輔助函數來獲取總人數和計算百分位
async function calculatePercentile(userRank) {
    if (!firebaseInitialized) {
        // 模擬模式
        const totalUsers = 12987;
        const percentile = Math.round((1 - (userRank / totalUsers)) * 100);
        return { totalUsers, percentile };
    }

    try {
        const statsDoc = await db.collection('stats').doc('global').get();
        if (statsDoc.exists) {
            const totalUsers = statsDoc.data().total_users;
            const percentile = Math.round((1 - (userRank / totalUsers)) * 100);
            return { totalUsers, percentile };
        }
        // 如果 stats 文件不存在，給一個預設值
        return { totalUsers: 1, percentile: 100 };
    } catch (error) {
        console.error('獲取總用戶數失敗:', error);
        // 失敗時的回退方案
        const totalUsers = 12987; // 使用一個大概的數字
        const percentile = Math.round((1 - (userRank / totalUsers)) * 100);
        return { totalUsers, percentile };
    }
}

        function determineLevel(score) {
            if (score <= 8) return 'bronze';
            if (score <= 12) return 'silver';
            if (score <= 16) return 'gold';
            if (score <= 20) return 'diamond';
            return 'master';
        }

function showResult(level, score, rank, percentile, total) {
    const levelData = {
        bronze: { badge: '🥉', title: 'AI 新手村', color: '#CD7F32' },
        silver: { badge: '🥈', title: 'AI 探索者', color: '#C0C0C0' },
        gold: { badge: '🥇', title: 'AI 實踐家', color: '#FFD700' },
        diamond: { badge: '💎', title: 'AI 專家', color: '#B9F2FF' },
        master: { badge: '👑', title: 'AI 大師', color: '#9400D3' }
    };

    const data = levelData[level] || levelData["bronze"];

    document.getElementById('testContainer').style.display = 'none';
    document.getElementById('resultBadge').textContent = data.badge;
    document.getElementById('resultTitle').textContent = data.title;
    document.getElementById('resultDescription').textContent = getResultDescription(level);
    document.getElementById('userScore').textContent = `${score}/25`;
    document.getElementById('userRank').textContent = `#${rank.toLocaleString()} / ${total}`;
    document.getElementById('userPercentile').textContent = `前${percentile}%`;

    document.getElementById('resultContainer').classList.add('show');
    document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });

    createCelebration();
}

        function getResultDescription(level) {
            const descriptions = {
                bronze: '你剛開始接觸 AI 世界！每個專家都是從新手開始的，繼續探索 AI 的無限可能吧！',
                silver: '你已經開始熟悉 AI 工具！繼續學習進階技巧，很快就能成為 AI 實踐家。',
                gold: '恭喜！你已經能夠熟練運用 AI 提升工作效率，屬於 AI 時代的先行者！',
                diamond: '太厲害了！你是真正的 AI 專家，能夠深度整合 AI 到日常工作流程中。',
                master: '哇！你是 AI 領域的頂尖大師！你的 AI 能力已經達到專業級水準，可以成為他人的導師。'
            };
            return descriptions[level];
        }

        // ===============================
        // UI 功能函數
        // ===============================

        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p style="color: #666; margin: 0;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function createCelebration() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.innerHTML = ['🎉', '✨', '🎊', '⭐'][Math.floor(Math.random() * 4)];
                    confetti.style.cssText = `
                        position: fixed;
                        left: ${Math.random() * 100}vw;
                        top: -10px;
                        font-size: 20px;
                        z-index: 1000;
                        pointer-events: none;
                        animation: fall ${Math.random() * 3 + 2}s linear forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 100);
            }
        }

        async function showLeaderboard() {
            document.getElementById('leaderboardSection').style.display = 'block';
            document.getElementById('leaderboardSection').scrollIntoView({ behavior: 'smooth' });
            
            const leaderboard = await getLeaderboard();
            const content = document.getElementById('leaderboardContent');
            
            if (leaderboard.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #666;">暫無排行榜數據</p>';
                return;
            }
            
            content.innerHTML = leaderboard.map(user => {
                const medal = user.rank === 1 ? '🥇' : user.rank === 2 ? '🥈' : user.rank === 3 ? '🥉' : '';
                const isCurrentUser = userResult && user.id === userResult.userId;
                
                return `
                    <div class="leaderboard-item" style="${isCurrentUser ? 'background: linear-gradient(135deg, #e3f2fd, #f0f8ff); border: 2px solid #2196f3;' : ''}">
                        ${medal ? `<div class="medal">${medal}</div>` : ''}
                        <div class="rank-number">#${user.rank}</div>
                        <div class="user-info">
                            <div class="username">${user.username} ${isCurrentUser ? '(你)' : ''}</div>
                            <div class="user-details">${user.location} · ${user.occupation}</div>
                        </div>
                        <div class="user-score">${user.score}分</div>
                    </div>
                `;
            }).join('');
        }

        function hideLeaderboard() {
            document.getElementById('leaderboardSection').style.display = 'none';
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function shareResult() {
            if (!userResult) return;
            
            const shareText = `我剛完成了全球首創的 AI 世代能力測驗！

🎯 我的段位：${document.getElementById('resultTitle').textContent}
📊 得分：${userResult.score}/25 分
🏆 全球排名：第 ${userResult.rank} 名

你的 AI 能力在全球處於什麼位置？快來測試看看！

由 Nick Chang | ZN Studio 創作
#AI測驗 #人工智慧 #ChatGPT #科技`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AI 世代能力測驗結果',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\n\n' + window.location.href).then(() => {
                    showNotification('結果已複製到剪貼簿！快去分享給朋友們吧 🎉');
                });
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
                animation: slideInRight 0.5s ease forwards;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // ===============================
        // 初始化
        // ===============================

        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        // 添加動畫CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 防止測驗進行中離開頁面
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                e.preventDefault();
                e.returnValue = '你的測驗進度將會遺失，確定要離開嗎？';
            }
        });
    </script>
</body>
</html>
